<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- 手機適應 -->
  <title>學生作業確認繳交</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      margin: 10px;
      padding: 0;
      background-color: #fafafa;
      color: #333;
    }
    h2 {
      text-align: center;
      font-size: 1.4em;
      margin-bottom: 10px;
    }
    button, input[type="text"], input[type="password"], input[type="file"] {
      font-size: 1em;
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
      font-size: 0.9em;
      overflow-x: auto;
      display: block;
      white-space: nowrap;
    }
    th, td {
      border: 1px solid #999;
      padding: 6px;
      text-align: center;
    }
    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .未交 { background-color: #fbb; cursor: pointer; }
    .未訂正 { background-color: #ff9; cursor: pointer; }
    .OK { background-color: #9f9; cursor: pointer; }
    .delete-btn, .edit-btn, .hide-btn {
      font-size: 0.8em;
      border: none;
      background: none;
      cursor: pointer;
      padding: 2px 4px;
    }
    .delete-btn { color: red; }
    .edit-btn { color: blue; }
    .hide-btn { color: orange; }
    #mainDiv { display: none; }
    #loginDiv {
      max-width: 320px;
      margin: 40px auto;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 8px;
      background-color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #loginDiv input {
      width: 100%;
    }
    #loginDiv button {
      width: 100%;
      margin-top: 10px;
    }
    #mainDiv {
      margin: auto;
      max-width: 95%;
    }
    /* 彈窗樣式 */
    #hiddenModal {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #aaa;
      border-radius: 10px;
      padding: 15px;
      z-index: 100;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      width: 90%;
      max-width: 350px;
    }
    #hiddenList label {
      display: block;
      margin: 5px 0;
    }
    #overlay {
      display: none;
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.5);
      z-index: 50;
    }
    /* 手機按鈕群組 */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
    }
    .btn-group button {
      flex: 1 1 45%;
      font-size: 0.9em;
    }
    @media (max-width: 600px) {
      th, td {
        font-size: 0.85em;
        padding: 5px;
      }
      button, input {
        font-size: 0.9em;
      }
      h2 { font-size: 1.2em; }
    }
  </style>
</head>
<body>
  <h2>學生作業確認繳交系統</h2>

  <!-- 登入區 -->
  <div id="loginDiv">
    <h3>老師登入</h3>
    <label>帳號：<input type="text" id="username" placeholder="請輸入帳號"></label><br>
    <label>密碼：<input type="password" id="password" placeholder="請輸入密碼"></label><br>
    <button onclick="login()">登入</button>
    <p id="loginMsg" style="color:red;text-align:center;"></p>
  </div>

  <!-- 主系統 -->
  <div id="mainDiv">
    <div class="btn-group">
      <input type="file" id="fileInput" accept=".csv">
      <input type="text" id="assignmentInput" placeholder="輸入作業名稱">
      <button onclick="addAssignment()">新增作業</button>
      <button onclick="openHiddenModal()">隱藏管理</button>

      <button onclick="exportCSV()">匯出紀錄</button>
      <input type="file" id="importData" accept=".csv">
      <button onclick="importCSV()">匯入資料</button>
    </div>

    <div style="overflow-x:auto;">
      <table id="studentTable">
        <thead>
          <tr id="headerRow">
            <th>座號</th>
            <th>姓名</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="studentBody"></tbody>
      </table>
    </div>
  </div>

  <!-- 隱藏作業管理彈窗 -->
  <div id="overlay" onclick="closeHiddenModal()"></div>
  <div id="hiddenModal">
    <h3>隱藏的作業項目</h3>
    <div id="hiddenList"></div>
    <br>
    <button onclick="restoreSelected()">顯示選取項目</button>
    <button onclick="closeHiddenModal()">關閉</button>
  </div>

<script>
  // Firebase 初始化
  const firebaseConfig = {
    apiKey: "AIzaSyCojnWzneUgiM_OTJYqf9oniIIYpyyuT_0",
    authDomain: "test-d18a6.firebaseapp.com",
    databaseURL: "https://test-d18a6-default-rtdb.firebaseio.com",
    projectId: "test-d18a6",
    storageBucket: "test-d18a6.firebasestorage.app",
    messagingSenderId: "441961430247",
    appId: "1:441961430247:web:643e53ce778132cfa47642"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const studentTableBody = document.getElementById("studentBody");
  const headerRow = document.getElementById("headerRow");

  // 登入驗證
  function login() {
    const user = document.getElementById("username").value.trim();
    const pwd = document.getElementById("password").value.trim();
    if (user === "walan52" && pwd === "source88") {
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("mainDiv").style.display = "block";
    } else {
      document.getElementById("loginMsg").innerText = "帳號或密碼錯誤！";
    }
  }

  // 匯入學生名單
  document.getElementById("fileInput").addEventListener("change", e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = e => {
      const rows = e.target.result.split("\n").map(r => r.split(","));
      rows.forEach(([id, name]) => {
        if (id && name) {
          const ref = db.ref("students/" + id.trim());
          ref.once("value", snap => {
            if (!snap.exists()) ref.set({ id: id.trim(), name: name.trim() });
          });
        }
      });
    };
    reader.readAsText(file);
  });

  // 新增作業項目
  function addAssignment() {
    const name = document.getElementById("assignmentInput").value.trim();
    if (!name) return;
    db.ref("assignments/" + name).set({ visible: true });
    document.getElementById("assignmentInput").value = "";
  }

  // 修改作業名稱
  function editAssignment(oldName) {
    const newName = prompt(`請輸入新的作業名稱（原名稱：${oldName}）`, oldName);
    if (!newName || newName.trim() === oldName) return;
    const clean = newName.trim();
    db.ref("assignments/" + clean).set({ visible: true });
    db.ref("assignments/" + oldName).remove();
    db.ref("students").once("value", snap => {
      const students = snap.val() || {};
      Object.keys(students).forEach(id => {
        const oldStatus = students[id].assignments && students[id].assignments[oldName] ? students[id].assignments[oldName] : "未交";
        db.ref(`students/${id}/assignments/${clean}`).set(oldStatus);
        db.ref(`students/${id}/assignments/${oldName}`).remove();
      });
    });
  }

  // 切換作業狀態
  function toggleStatus(id, name, status) {
    let next;
    if (status === "未交") next = "未訂正";
    else if (status === "未訂正") next = "OK";
    else next = "未交";
    db.ref(`students/${id}/assignments/${name}`).set(next);
  }

  // 刪除學生
  function deleteStudent(id) {
    if (confirm("確定要刪除這位學生嗎？")) db.ref("students/" + id).remove();
  }

  // 刪除作業
  function deleteAssignment(name) {
    if (!confirm(`確定刪除作業「${name}」嗎？`)) return;
    db.ref("assignments/" + name).remove();
    db.ref("students").once("value", snap => {
      const students = snap.val() || {};
      Object.keys(students).forEach(id => db.ref(`students/${id}/assignments/${name}`).remove());
    });
  }

  // 隱藏作業
  function hideAssignment(name) {
    db.ref(`assignments/${name}/visible`).set(false);
  }

  // 彈窗管理隱藏作業
  function openHiddenModal() {
    const modal = document.getElementById("hiddenModal");
    const overlay = document.getElementById("overlay");
    const list = document.getElementById("hiddenList");
    list.innerHTML = "";
    db.ref("assignments").once("value", snap => {
      const assignments = snap.val() || {};
      const hidden = Object.keys(assignments).filter(k => assignments[k].visible === false);
      if (hidden.length === 0) {
        list.innerHTML = "<p>目前沒有隱藏的作業項目。</p>";
      } else {
        hidden.forEach(name => {
          const label = document.createElement("label");
          label.innerHTML = `<input type="checkbox" value="${name}"> ${name}`;
          list.appendChild(label);
        });
      }
      modal.style.display = "block";
      overlay.style.display = "block";
    });
  }

  function closeHiddenModal() {
    document.getElementById("hiddenModal").style.display = "none";
    document.getElementById("overlay").style.display = "none";
  }

  function restoreSelected() {
    const checkboxes = document.querySelectorAll("#hiddenList input[type=checkbox]:checked");
    checkboxes.forEach(cb => db.ref(`assignments/${cb.value}/visible`).set(true));
    alert("已顯示所選作業項目！");
    closeHiddenModal();
  }

  // 匯出 CSV
  function exportCSV() {
    db.ref("students").once("value", snap => {
      const students = snap.val();
      if (!students) return;
      const headers = ["座號", "姓名"];
      const assignments = [];
      headerRow.querySelectorAll("th").forEach((th, i) => {
        if (i > 2) assignments.push(th.textContent.replace(/(修改|刪除|隱藏)/g, "").trim());
      });
      headers.push(...assignments);
      let csv = headers.join(",") + "\n";
      Object.values(students).forEach(stu => {
        const row = [stu.id, stu.name];
        assignments.forEach(a => row.push(stu.assignments && stu.assignments[a] ? stu.assignments[a] : "未交"));
        csv += row.join(",") + "\n";
      });
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "作業紀錄.csv";
      a.click();
    });
  }

  // 匯入作業資料
  function importCSV() {
    const file = document.getElementById("importData").files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const rows = e.target.result.split("\n").map(r => r.split(","));
      const headers = rows[0];
      if (!headers.includes("座號") || !headers.includes("姓名")) { alert("格式錯誤"); return; }
      const assigns = headers.slice(2);
      db.ref("assignments").set({});
      assigns.forEach(a => { if (a.trim()) db.ref("assignments/" + a.trim()).set({ visible: true }); });
      rows.slice(1).forEach(row => {
        if (row.length < 2) return;
        const id = row[0].trim(), name = row[1].trim();
        const data = { id, name, assignments: {} };
        assigns.forEach((a,i) => data.assignments[a.trim()] = row[i+2]?.trim() || "未交");
        db.ref("students/" + id).set(data);
      });
      alert("匯入完成！");
    };
    reader.readAsText(file, "UTF-8");
  }

  // 即時更新表格
  db.ref("assignments").on("value", snap => {
    const assigns = snap.val() || {};
    headerRow.innerHTML = "<th>座號</th><th>姓名</th><th>操作</th>";
    Object.keys(assigns).forEach(a => {
      if (assigns[a].visible !== false) {
        const th = document.createElement("th");
        th.innerHTML = `${a}
          <button class='edit-btn' onclick="editAssignment('${a}')">修改</button>
          <button class='hide-btn' onclick="hideAssignment('${a}')">隱藏</button>
          <button class='delete-btn' onclick="deleteAssignment('${a}')">刪除</button>`;
        headerRow.appendChild(th);
      }
    });
  });

  db.ref("students").on("value", snap => {
    const students = snap.val() || {};
    studentTableBody.innerHTML = "";
    db.ref("assignments").once("value", s2 => {
      const assigns = s2.val() || {};
      Object.values(students).forEach(stu => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${stu.id}</td><td>${stu.name}</td><td><button style='background:#f55;' onclick="deleteStudent('${stu.id}')">刪除</button></td>`;
        Object.keys(assigns).forEach(a => {
          if (assigns[a].visible !== false) {
            const status = stu.assignments?.[a] || "未交";
            const td = document.createElement("td");
            td.textContent = status;
            td.className = status;
            td.onclick = () => toggleStatus(stu.id, a, status);
            tr.appendChild(td);
          }
        });
        studentTableBody.appendChild(tr);
      });
    });
  });
</script>
</body>
</html>
