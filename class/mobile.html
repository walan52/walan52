<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>學生作業確認繳交（含分類）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    /* 版面基礎 */
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      padding: 0;
      background: #fff;
      -webkit-tap-highlight-color: transparent; /* 手機點擊無藍框 */
    }
    h2, h3 {
      text-align: center;
      margin-bottom: 12px;
    }

    /* 表格與按鈕 */
    table {
      border-collapse: collapse;
      margin-top: 15px;
      width: 100%;
      table-layout: fixed;
      word-wrap: break-word;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #999;
      padding: 8px 6px;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: 13px;
      padding: 6px 4px;
      word-break: break-word;
    }
    button {
      margin: 3px 2px;
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 5px;
      border: 1.5px solid #888;
      background-color: #f9f9f9;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #ddd;
    }
    .net-btn {
      min-width: 55px;
      padding: 5px 8px;
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
      border: none;
    }
    .有網 { background-color: #4CAF50; }
    .無網 { background-color: #E53935; }

    /* 狀態色 */
    .未交 { background-color: #fbb; cursor: pointer; }
    .未訂正 { background-color: #ff9; cursor: pointer; }
    .OK { background-color: #9f9; cursor: pointer; }

    /* 小按鈕樣式 */
    .delete-btn, .edit-btn, .hide-btn {
      font-size: 11px;
      border: none;
      background: none;
      cursor: pointer;
      padding: 0 3px;
      margin: 0 1px;
      user-select: none;
      vertical-align: middle;
    }
    .delete-btn { color: #d33; }
    .edit-btn { color: #06c; }
    .hide-btn { color: #e90; }

    /* 表單和輸入區 */
    input[type="text"], input[type="password"], select, input[type="file"] {
      width: 100%;
      max-width: 300px;
      padding: 8px 10px;
      margin: 6px 0 10px 0;
      box-sizing: border-box;
      border: 1.5px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }
    label {
      font-size: 14px;
      display: block;
      margin: 10px auto 5px auto;
      max-width: 300px;
      text-align: left;
    }
    #loginDiv, #mainDiv {
      max-width: 450px;
      margin: auto;
    }

    /* 分類選單區 */
    #categorySelect, #newCategory, #filterCategory {
      width: calc(50% - 12px);
      max-width: 180px;
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
    }
    #newCategory {
      margin-right: 0;
    }
    #filterCategory {
      max-width: 200px;
    }

    /* 分頁區 */
    #pagination {
      margin-top: 12px;
      text-align: center;
      user-select: none;
    }
    #pageInfo {
      font-size: 14px;
      margin: 0 12px;
      vertical-align: middle;
      display: inline-block;
      min-width: 90px;
    }

    /* 彈窗與遮罩 */
    #hiddenModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 90%;
      max-width: 360px;
      max-height: 70vh;
      overflow-y: auto;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #aaa;
      border-radius: 8px;
      padding: 18px 20px 20px 20px;
      z-index: 100;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      font-size: 14px;
    }
    #hiddenList label {
      display: block;
      margin: 6px 0;
      user-select: none;
    }
    #overlay {
      display: none;
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.5);
      z-index: 50;
      touch-action: none;
    }

    /* 手機直式表格滾動 */
    #studentTable {
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 4px;
      border: 1px solid #999;
      font-size: 13px;
    }

    /* 輸入區小螢幕調整 */
    @media screen and (max-width: 480px) {
      input[type="text"], input[type="password"], select, input[type="file"] {
        max-width: 100%;
      }
      #categorySelect, #newCategory, #filterCategory {
        width: 100%;
        max-width: 100%;
        margin-bottom: 8px;
      }
      button {
        width: 100%;
        box-sizing: border-box;
        margin: 6px 0;
      }
      .delete-btn, .edit-btn, .hide-btn {
        font-size: 12px;
        padding: 1px 4px;
      }
      th, td {
        padding: 6px 4px;
      }
      #pageInfo {
        display: block;
        margin: 6px 0;
      }
      #pagination button {
        width: 48%;
        font-size: 14px;
        margin: 3px 1%;
      }
    }
  </style>
</head>
<body>
  <h2>學生作業確認繳交系統（含分類）</h2>

  <!-- 登入區 -->
  <div id="loginDiv">
    <h3>老師登入</h3>
    <label>帳號：<input type="text" id="username" autocomplete="username"></label>
    <label>密碼：<input type="password" id="password" autocomplete="current-password"></label>
    <button onclick="login()">登入</button>
    <p id="loginMsg" style="color:red; margin-top:6px;"></p>
  </div>

  <!-- 主系統 -->
  <div id="mainDiv" style="display:none;">
    <input type="file" id="fileInput" accept=".csv">
    <input type="text" id="assignmentInput" placeholder="輸入作業名稱" autocomplete="off">
    <select id="categorySelect"></select>
    <input type="text" id="newCategory" placeholder="新增分類" autocomplete="off">
    <button onclick="addAssignment()">新增作業項目</button>
    <button onclick="openHiddenModal()">管理隱藏作業項目</button>
    <button onclick="exportCSV()">匯出紀錄</button>
    <input type="file" id="importData" accept=".csv">
    <button onclick="importCSV()">匯入資料</button>

    <div style="margin-top:10px;">
      <label for="filterCategory">依分類顯示：</label>
      <select id="filterCategory" onchange="renderTable()"></select>
    </div>

    <div id="pagination">
      <button onclick="prevPage()">⬅ 上一頁</button>
      <span id="pageInfo"></span>
      <button onclick="nextPage()">下一頁 ➡</button>
    </div>

    <table id="studentTable" aria-label="學生作業狀態表">
      <thead>
        <tr id="headerRow">
          <th scope="col">座號</th>
          <th scope="col">姓名</th>
          <th scope="col">網區狀態</th>
          <th scope="col">操作</th>
        </tr>
      </thead>
      <tbody id="studentBody"></tbody>
    </table>
  </div>

  <!-- 隱藏作業管理彈窗 -->
  <div id="overlay" onclick="closeHiddenModal()"></div>
  <div id="hiddenModal" role="dialog" aria-modal="true" aria-labelledby="hiddenModalTitle">
    <h3 id="hiddenModalTitle">隱藏的作業項目</h3>
    <div id="hiddenList"></div>
    <br>
    <button onclick="restoreSelected()">顯示所選作業項目</button>
    <button onclick="closeHiddenModal()">關閉</button>
  </div>

<script>
  // Firebase 初始化
  const firebaseConfig = {
    apiKey: "AIzaSyCojnWzneUgiM_OTJYqf9oniIIYpyyuT_0",
    authDomain: "test-d18a6.firebaseapp.com",
    databaseURL: "https://test-d18a6-default-rtdb.firebaseio.com",
    projectId: "test-d18a6",
    storageBucket: "test-d18a6.firebasestorage.app",
    messagingSenderId: "441961430247",
    appId: "1:441961430247:web:643e53ce778132cfa47642"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const studentTableBody = document.getElementById("studentBody");
  const headerRow = document.getElementById("headerRow");

  let currentPage = 1;
  const itemsPerPage = 10;
  let assignmentList = [];
  let allAssignments = {};

  // 登入驗證
  function login() {
    const user = document.getElementById("username").value.trim();
    const pwd = document.getElementById("password").value.trim();
    if (user === "walan52" && pwd === "source88") {
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("mainDiv").style.display = "block";
      loadCategories();
    } else {
      document.getElementById("loginMsg").innerText = "帳號或密碼錯誤！";
    }
  }

  // 匯入學生名單
  document.getElementById("fileInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const rows = e.target.result.split("\n").map(r => r.split(","));
      rows.forEach(([id, name]) => {
        if (id && name) {
          const ref = db.ref("students/" + id.trim());
          ref.once("value", snap => {
            if (!snap.exists()) ref.set({ id: id.trim(), name: name.trim(), netStatus: "無網" });
          });
        }
      });
    };
    reader.readAsText(file);
    e.target.value = null; // 清空檔案選擇器
  });

  // 新增作業項目 + 分類
  function addAssignment() {
    const name = document.getElementById("assignmentInput").value.trim();
    let category = document.getElementById("categorySelect").value;
    const newCat = document.getElementById("newCategory").value.trim();
    if (!name) return alert("請輸入作業名稱");
    if (newCat) category = newCat;
    if (!category) category = "未分類";

    db.ref("assignments/" + name).set({ visible: true, category });
    document.getElementById("assignmentInput").value = "";
    document.getElementById("newCategory").value = "";
  }

  // 讀取分類清單
  function loadCategories() {
    db.ref("assignments").once("value", snap => {
      const assigns = snap.val() || {};
      const cats = new Set(Object.values(assigns).map(a => a.category || "未分類"));
      const select = document.getElementById("categorySelect");
      const filter = document.getElementById("filterCategory");
      select.innerHTML = "";
      filter.innerHTML = `<option value="全部">全部</option>`;
      cats.forEach(c => {
        select.innerHTML += `<option value="${c}">${c}</option>`;
        filter.innerHTML += `<option value="${c}">${c}</option>`;
      });
    });
  }

  // 渲染表格（含分類篩選）
  function renderTable() {
    db.ref("assignments").once("value", snap => {
      allAssignments = snap.val() || {};
      const selectedCategory = document.getElementById("filterCategory").value || "全部";
      const visible = Object.keys(allAssignments).filter(a =>
        allAssignments[a].visible !== false &&
        (selectedCategory === "全部" || allAssignments[a].category === selectedCategory)
      );
      assignmentList = visible;

      const totalPages = Math.ceil(visible.length / itemsPerPage);
      if (currentPage > totalPages) currentPage = totalPages || 1;
      updatePageInfo(totalPages);

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const currentAssignments = visible.slice(start, end);

      headerRow.innerHTML = "<th>座號</th><th>姓名</th><th>網區狀態</th><th>操作</th>";
      currentAssignments.forEach(a => {
        const th = document.createElement("th");
        th.style.minWidth = "85px";
        th.style.wordBreak = "break-word";
        th.innerHTML = `${a}<br><small>${allAssignments[a].category || "未分類"}</small>
          <br>
          <button class='edit-btn' aria-label="修改作業名稱：${a}" onclick="editAssignment('${a}')">修改</button>
          <button class='hide-btn' aria-label="隱藏作業：${a}" onclick="hideAssignment('${a}')">隱藏</button>
          <button class='delete-btn' aria-label="刪除作業：${a}" onclick="deleteAssignment('${a}')">刪除</button>`;
        headerRow.appendChild(th);
      });

      db.ref("students").once("value", s2 => {
        const students = s2.val() || {};
        studentTableBody.innerHTML = "";
        Object.values(students).forEach(stu => {
          const tr = document.createElement("tr");
          const net = stu.netStatus || "無網";
          tr.innerHTML = `
            <td>${stu.id}</td>
            <td>${stu.name}</td>
            <td><button class="net-btn ${net}" aria-label="切換網區狀態" onclick="toggleNetStatus('${stu.id}','${net}')">${net}</button></td>
            <td><button aria-label="刪除學生 ${stu.name}" onclick="deleteStudent('${stu.id}')">刪除</button></td>`;
          currentAssignments.forEach(a => {
            const status = stu.assignments?.[a] || "未交";
            const td = document.createElement("td");
            td.textContent = status;
            td.className = status;
            td.style.minWidth = "60px";
            td.style.cursor = "pointer";
            td.setAttribute("tabindex", "0");
            td.setAttribute("role", "button");
            td.setAttribute("aria-label", `${stu.name} 的作業 ${a} 狀態：${status}，點擊切換`);
            td.addEventListener("click", () => toggleStatus(stu.id, a, status));
            td.addEventListener("keydown", e => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                toggleStatus(stu.id, a, status);
              }
            });
            tr.appendChild(td);
          });
          studentTableBody.appendChild(tr);
        });
      });
    });
  }

  // 其他功能維持不變
  function updatePageInfo(totalPages) {
    document.getElementById("pageInfo").textContent = `第 ${currentPage} 頁 / 共 ${totalPages} 頁`;
  }
  function nextPage() {
    const totalPages = Math.ceil(assignmentList.length / itemsPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      renderTable();
    }
  }
  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      renderTable();
    }
  }
  function toggleStatus(id, name, status) {
    let next = status === "未交" ? "未訂正" : status === "未訂正" ? "OK" : "未交";
    db.ref(`students/${id}/assignments/${name}`).set(next);
  }
  function toggleNetStatus(id, current) {
    const next = current === "有網" ? "無網" : "有網";
    db.ref(`students/${id}/netStatus`).set(next);
  }
  function deleteStudent(id) {
    if (confirm("確定刪除這位學生嗎？")) db.ref("students/" + id).remove();
  }
  function editAssignment(oldName) {
    const newName = prompt(`請輸入新的作業名稱（原名稱：${oldName}）`, oldName);
    if (!newName || newName.trim() === oldName) return;
    const clean = newName.trim();
    const cat = allAssignments[oldName]?.category || "未分類";
    db.ref("assignments/" + clean).set({ visible: true, category: cat });
    db.ref("assignments/" + oldName).remove();
    db.ref("students").once("value", snap => {
      const students = snap.val() || {};
      Object.keys(students).forEach(id => {
        const oldStatus = students[id].assignments && students[id].assignments[oldName] ? students[id].assignments[oldName] : "未交";
        db.ref(`students/${id}/assignments/${clean}`).set(oldStatus);
        db.ref(`students/${id}/assignments/${oldName}`).remove();
      });
    });
  }
  function deleteAssignment(name) {
    if (!confirm(`確定刪除作業「${name}」嗎？`)) return;
    db.ref("assignments/" + name).remove();
    db.ref("students").once("value", snap => {
      const students = snap.val() || {};
      Object.keys(students).forEach(id => db.ref(`students/${id}/assignments/${name}`).remove());
    });
  }
  function hideAssignment(name) {
    db.ref(`assignments/${name}/visible`).set(false);
  }
  function openHiddenModal() {
    const modal = document.getElementById("hiddenModal");
    const overlay = document.getElementById("overlay");
    const list = document.getElementById("hiddenList");
    list.innerHTML = "";
    db.ref("assignments").once("value", snap => {
      const assignments = snap.val() || {};
      const hidden = Object.keys(assignments).filter(k => assignments[k].visible === false);
      if (hidden.length === 0) {
        list.innerHTML = "<p>目前沒有隱藏的作業項目。</p>";
      } else {
        hidden.forEach(name => {
          const label = document.createElement("label");
          label.innerHTML = `<input type="checkbox" value="${name}"> ${name}`;
          list.appendChild(label);
        });
      }
      modal.style.display = "block";
      overlay.style.display = "block";
    });
  }
  function closeHiddenModal() {
    document.getElementById("hiddenModal").style.display = "none";
    document.getElementById("overlay").style.display = "none";
  }
  function restoreSelected() {
    const checkboxes = document.querySelectorAll("#hiddenList input[type=checkbox]:checked");
    if (checkboxes.length === 0) {
      alert("請先選擇要顯示的作業項目！");
      return;
    }
    checkboxes.forEach(cb => db.ref(`assignments/${cb.value}/visible`).set(true));
    alert("已顯示所選作業項目！");
    closeHiddenModal();
  }
  function exportCSV() {
    db.ref("students").once("value", snap => {
      const students = snap.val();
      if (!students) return;
      const headers = ["座號", "姓名", "網區狀態"];
      const visibleAssignments = assignmentList;
      headers.push(...visibleAssignments);
      let csv = headers.join(",") + "\n";
      Object.values(students).forEach(stu => {
        const row = [stu.id, stu.name, stu.netStatus || "無網"];
        visibleAssignments.forEach(a => row.push(stu.assignments && stu.assignments[a] ? stu.assignments[a] : "未交"));
        csv += row.join(",") + "\n";
      });
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "作業紀錄.csv";
      a.click();
    });
  }

  // 匯入資料 (外部按鈕觸發)
  function importCSV() {
    const input = document.getElementById("importData");
    const file = input.files[0];
    if (!file) {
      alert("請選擇 CSV 檔案");
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      const text = e.target.result;
      // 簡單 CSV 解析（第一行為表頭）
      const lines = text.trim().split("\n");
      if (lines.length < 2) {
        alert("CSV 格式不正確");
        return;
      }
      const headers = lines[0].split(",");
      const assignmentHeaders = headers.slice(3);
      lines.slice(1).forEach(line => {
        const cols = line.split(",");
        const id = cols[0].trim();
        const name = cols[1].trim();
        const netStatus = cols[2].trim();
        if (!id || !name) return;
        const stuRef = db.ref(`students/${id}`);
        stuRef.once("value", snap => {
          const data = snap.val() || {};
          const assignments = data.assignments || {};
          assignmentHeaders.forEach((a, i) => {
            assignments[a] = cols[3 + i] ? cols[3 + i].trim() : "未交";
          });
          stuRef.set({ id, name, netStatus, assignments });
        });
      });
      input.value = null;
      alert("匯入完成");
    };
    reader.readAsText(file);
  }

  db.ref("assignments").on("value", () => {
    loadCategories();
    renderTable();
  });
  db.ref("students").on("value", () => renderTable());
</script>
</body>
</html>
