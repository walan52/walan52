<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å­¸ç”Ÿä½œæ¥­ç¢ºèªç¹³äº¤ï¼ˆå«åˆ†é¡ï¼‰</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #999; padding: 6px; text-align: center; }
    th { background: #f0f0f0; position: sticky; top: 0; z-index: 2; }
    button { margin: 2px; }
    .æœªäº¤ { background-color: #fbb; cursor: pointer; }
    .æœªè¨‚æ­£ { background-color: #ff9; cursor: pointer; }
    .OK { background-color: #9f9; cursor: pointer; }
    .delete-btn, .edit-btn, .hide-btn { font-size: 10px; border: none; background: none; cursor: pointer; }
    .delete-btn { color: red; }
    .edit-btn { color: blue; }
    .hide-btn { color: orange; }
    #mainDiv { display: none; }
    #loginDiv { max-width: 300px; margin: auto; border: 1px solid #ccc; padding: 20px; border-radius: 6px; }
    #hiddenModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                   background: #fff; border: 1px solid #aaa; border-radius: 8px;
                   padding: 20px; z-index: 100; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    #hiddenList label { display: block; margin: 5px 0; }
    #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%;
               background: rgba(0,0,0,0.5); z-index: 50; }
    #pagination { margin-top: 10px; text-align: center; }
    .net-btn { cursor: pointer; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; }
    .æœ‰ç¶² { background-color: #4CAF50; }
    .ç„¡ç¶² { background-color: #E53935; }
    #categorySelect, #newCategory { margin: 5px; }
  </style>
</head>
<body>
  <h2>å­¸ç”Ÿä½œæ¥­ç¢ºèªç¹³äº¤ç³»çµ±ï¼ˆå«åˆ†é¡ï¼‰</h2>

  <!-- ç™»å…¥å€ -->
  <div id="loginDiv">
    <h3>è€å¸«ç™»å…¥</h3>
    <label>å¸³è™Ÿï¼š<input type="text" id="username"></label><br><br>
    <label>å¯†ç¢¼ï¼š<input type="password" id="password"></label><br><br>
    <button onclick="login()">ç™»å…¥</button>
    <p id="loginMsg" style="color:red"></p>
  </div>

  <!-- ä¸»ç³»çµ± -->
  <div id="mainDiv">
    <input type="file" id="fileInput" accept=".csv">
    <input type="text" id="assignmentInput" placeholder="è¼¸å…¥ä½œæ¥­åç¨±">
    <select id="categorySelect"></select>
    <input type="text" id="newCategory" placeholder="æ–°å¢åˆ†é¡">
    <button onclick="addAssignment()">æ–°å¢ä½œæ¥­é …ç›®</button>
    <button onclick="openHiddenModal()">ç®¡ç†éš±è—ä½œæ¥­é …ç›®</button>
    <button onclick="exportCSV()">åŒ¯å‡ºç´€éŒ„</button>
    <input type="file" id="importData" accept=".csv">
    <button onclick="importCSV()">åŒ¯å…¥è³‡æ–™</button>

    <div style="margin-top:10px;">
      <label>ä¾åˆ†é¡é¡¯ç¤ºï¼š</label>
      <select id="filterCategory" onchange="renderTable()"></select>
    </div>

    <div id="pagination">
      <button onclick="prevPage()">â¬… ä¸Šä¸€é </button>
      <span id="pageInfo"></span>
      <button onclick="nextPage()">ä¸‹ä¸€é  â¡</button>
    </div>

    <table id="studentTable">
      <thead>
        <tr id="headerRow">
          <th>åº§è™Ÿ</th>
          <th>å§“å</th>
          <th>ç¶²å€ç‹€æ…‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="studentBody"></tbody>
    </table>
  </div>

  <!-- éš±è—ä½œæ¥­ç®¡ç†å½ˆçª— -->
  <div id="overlay" onclick="closeHiddenModal()"></div>
  <div id="hiddenModal">
    <h3>éš±è—çš„ä½œæ¥­é …ç›®</h3>
    <div id="hiddenList"></div>
    <br>
    <button onclick="restoreSelected()">é¡¯ç¤ºæ‰€é¸ä½œæ¥­é …ç›®</button>
    <button onclick="closeHiddenModal()">é—œé–‰</button>
  </div>

<script>
  // ğŸ”¥ Firebase åˆå§‹åŒ– - å·²æ”¹ç‚ºä½ çµ¦çš„è³‡æ–™
  const firebaseConfig = {
    apiKey: "AIzaSyBIZByjsGNwP949OSVsyi7-PjU7Cpz-gzI",
    authDomain: "student-score-app-6cca6.firebaseapp.com",
    databaseURL: "https://student-score-app-6cca6-default-rtdb.firebaseio.com",
    projectId: "student-score-app-6cca6",
    storageBucket: "student-score-app-6cca6.firebasestorage.app",
    messagingSenderId: "887092013369",
    appId: "1:887092013369:web:42abc19c8cacca737b20e8",
    measurementId: "G-8SREJH2ER3"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const studentTableBody = document.getElementById("studentBody");
  const headerRow = document.getElementById("headerRow");

  let currentPage = 1;
  const itemsPerPage = 10;
  let assignmentList = [];
  let allAssignments = {};

  // ç™»å…¥é©—è­‰
  function login() {
    const user = document.getElementById("username").value.trim();
    const pwd = document.getElementById("password").value.trim();
    if (user === "walan52" && pwd === "source88") {
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("mainDiv").style.display = "block";
      loadCategories();
    } else {
      document.getElementById("loginMsg").innerText = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼";
    }
  }

  // åŒ¯å…¥å­¸ç”Ÿåå–®
  document.getElementById("fileInput").addEventListener("change", e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = e => {
      const rows = e.target.result.split("\n").map(r => r.split(","));
      rows.forEach(([id, name]) => {
        if (id && name) {
          const ref = db.ref("students/" + id.trim());
          ref.once("value", snap => {
            if (!snap.exists()) ref.set({ id: id.trim(), name: name.trim(), netStatus: "ç„¡ç¶²" });
          });
        }
      });
    };
    reader.readAsText(file);
  });

  // æ–°å¢ä½œæ¥­é …ç›® + åˆ†é¡
  function addAssignment() {
    const name = document.getElementById("assignmentInput").value.trim();
    let category = document.getElementById("categorySelect").value;
    const newCat = document.getElementById("newCategory").value.trim();
    if (!name) return;

    if (newCat) category = newCat;
    if (!category) category = "æœªåˆ†é¡";

    db.ref("assignments/" + name).set({ visible: true, category });
    document.getElementById("assignmentInput").value = "";
    document.getElementById("newCategory").value = "";
  }

  // è®€å–åˆ†é¡æ¸…å–®
  function loadCategories() {
    db.ref("assignments").once("value", snap => {
      const assigns = snap.val() || {};
      const cats = new Set(Object.values(assigns).map(a => a.category || "æœªåˆ†é¡"));
      const select = document.getElementById("categorySelect");
      const filter = document.getElementById("filterCategory");
      select.innerHTML = "";
      filter.innerHTML = `<option value="å…¨éƒ¨">å…¨éƒ¨</option>`;
      cats.forEach(c => {
        select.innerHTML += `<option value="${c}">${c}</option>`;
        filter.innerHTML += `<option value="${c}">${c}</option>`;
      });
    });
  }

  // æ¸²æŸ“è¡¨æ ¼ï¼ˆå«åˆ†é¡ç¯©é¸ï¼‰
  function renderTable() {
    db.ref("assignments").once("value", snap => {
      allAssignments = snap.val() || {};
      const selectedCategory = document.getElementById("filterCategory").value || "å…¨éƒ¨";
      const visible = Object.keys(allAssignments).filter(a =>
        allAssignments[a].visible !== false &&
        (selectedCategory === "å…¨éƒ¨" || allAssignments[a].category === selectedCategory)
      );
      assignmentList = visible;

      const totalPages = Math.ceil(visible.length / itemsPerPage);
      updatePageInfo(totalPages);

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const currentAssignments = visible.slice(start, end);

      headerRow.innerHTML = "<th>åº§è™Ÿ</th><th>å§“å</th><th>ç¶²å€ç‹€æ…‹</th><th>æ“ä½œ</th>";
      currentAssignments.forEach(a => {
        const th = document.createElement("th");
        th.innerHTML = `${a}<br><small>${allAssignments[a].category || "æœªåˆ†é¡"}</small>
          <button class='edit-btn' onclick="editAssignment('${a}')">ä¿®æ”¹</button>
          <button class='hide-btn' onclick="hideAssignment('${a}')">éš±è—</button>
          <button class='delete-btn' onclick="deleteAssignment('${a}')">åˆªé™¤</button>`;
        headerRow.appendChild(th);
      });

      db.ref("students").once("value", s2 => {
        const students = s2.val() || {};
        studentTableBody.innerHTML = "";
        Object.values(students).forEach(stu => {
          const tr = document.createElement("tr");
          const net = stu.netStatus || "ç„¡ç¶²";
          tr.innerHTML = `
            <td>${stu.id}</td>
            <td>${stu.name}</td>
            <td><button class="net-btn ${net}" onclick="toggleNetStatus('${stu.id}','${net}')">${net}</button></td>
            <td><button onclick="deleteStudent('${stu.id}')">åˆªé™¤</button></td>`;
          currentAssignments.forEach(a => {
            const status = stu.assignments?.[a] || "æœªäº¤";
            const td = document.createElement("td");
            td.textContent = status;
            td.className = status;
            td.onclick = () => toggleStatus(stu.id, a, status);
            tr.appendChild(td);
          });
          studentTableBody.appendChild(tr);
        });
      });
    });
  }

  // å…¶ä»–åŠŸèƒ½
  function updatePageInfo(totalPages){document.getElementById("pageInfo").textContent=`ç¬¬ ${currentPage} é  / å…± ${totalPages} é `;}
  function nextPage(){const totalPages=Math.ceil(assignmentList.length/itemsPerPage);if(currentPage<totalPages){currentPage++;renderTable();}}
  function prevPage(){if(currentPage>1){currentPage--;renderTable();}}
  function toggleStatus(id,name,status){let next=status==="æœªäº¤"?"æœªè¨‚æ­£":status==="æœªè¨‚æ­£"?"OK":"æœªäº¤";db.ref(`students/${id}/assignments/${name}`).set(next);}
  function toggleNetStatus(id,current){const next=current==="æœ‰ç¶²"?"ç„¡ç¶²":"æœ‰ç¶²";db.ref(`students/${id}/netStatus`).set(next);}
  function deleteStudent(id){if(confirm("ç¢ºå®šåˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿ"))db.ref("students/"+id).remove();}
  function editAssignment(oldName){const newName=prompt(`è«‹è¼¸å…¥æ–°çš„ä½œæ¥­åç¨±ï¼ˆåŸåç¨±ï¼š${oldName}ï¼‰`,oldName);if(!newName||newName.trim()===oldName)return;const clean=newName.trim();
    const cat=allAssignments[oldName]?.category||"æœªåˆ†é¡";
    db.ref("assignments/"+clean).set({visible:true,category:cat});
    db.ref("assignments/"+oldName).remove();
    db.ref("students").once("value",snap=>{
      const students=snap.val()||{};
      Object.keys(students).forEach(id=>{
        const oldStatus=students[id].assignments&&students[id].assignments[oldName]?students[id].assignments[oldName]:"æœªäº¤";
        db.ref(`students/${id}/assignments/${clean}`).set(oldStatus);
        db.ref(`students/${id}/assignments/${oldName}`).remove();
      });
    });
  }
  function deleteAssignment(name){if(!confirm(`ç¢ºå®šåˆªé™¤ä½œæ¥­ã€Œ${name}ã€å—ï¼Ÿ`))return;db.ref("assignments/"+name).remove();db.ref("students").once("value",snap=>{
    const students=snap.val()||{};Object.keys(students).forEach(id=>db.ref(`students/${id}/assignments/${name}`).remove());});}
  function hideAssignment(name){db.ref(`assignments/${name}/visible`).set(false);}
  function openHiddenModal(){const modal=document.getElementById("hiddenModal");const overlay=document.getElementById("overlay");const list=document.getElementById("hiddenList");
    list.innerHTML="";db.ref("assignments").once("value",snap=>{const assignments=snap.val()||{};const hidden=Object.keys(assignments).filter(k=>assignments[k].visible===false);
      if(hidden.length===0){list.innerHTML="<p>ç›®å‰æ²’æœ‰éš±è—çš„ä½œæ¥­é …ç›®ã€‚</p>";}else{hidden.forEach(name=>{const label=document.createElement("label");
        label.innerHTML=`<input type="checkbox" value="${name}"> ${name}`;list.appendChild(label);});}
      modal.style.display="block";overlay.style.display="block";});}
  function closeHiddenModal(){document.getElementById("hiddenModal").style.display="none";document.getElementById("overlay").style.display="none";}
  function restoreSelected(){const checkboxes=document.querySelectorAll("#hiddenList input[type=checkbox]:checked");
    checkboxes.forEach(cb=>db.ref(`assignments/${cb.value}/visible`).set(true));alert("å·²é¡¯ç¤ºæ‰€é¸ä½œæ¥­é …ç›®ï¼");closeHiddenModal();}
  function exportCSV(){db.ref("students").once("value",snap=>{
    const students=snap.val();if(!students)return;
    const headers=["åº§è™Ÿ","å§“å","ç¶²å€ç‹€æ…‹"];const visibleAssignments=assignmentList;
    headers.push(...visibleAssignments);let csv=headers.join(",")+"\n";
    Object.values(students).forEach(stu=>{
      const row=[stu.id,stu.name,stu.netStatus||"ç„¡ç¶²"];
      visibleAssignments.forEach(a=>row.push(stu.assignments&&stu.assignments[a]?stu.assignments[a]:"æœªäº¤"));
      csv+=row.join(",")+"\n";
    });
    const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="ä½œæ¥­ç´€éŒ„.csv";a.click();});
  }

  db.ref("assignments").on("value",()=>{loadCategories();renderTable();});
  db.ref("students").on("value",()=>renderTable());
</script>
</body>
</html>
