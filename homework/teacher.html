<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è€å¸«è¨­å®šé </title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { display: none; font-family: sans-serif; }
    .logout-btn { margin-top: 30px; color: white; background: #d9534f; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>å­¸ç”Ÿåå–®åŒ¯å…¥</h2>
  <input type="file" id="excelFile" />
  <button onclick="importExcel()">åŒ¯å…¥</button>

  <h3>æ–°å¢å­¸ç”Ÿ</h3>
  <input id="no" placeholder="åº§è™Ÿ" />
  <input id="name" placeholder="å§“å" />
  <button onclick="addStudent()">æ–°å¢</button>

  <h3>ç™»éŒ„ç©æ¬ ä½œæ¥­</h3>
  <select id="studentSelect"></select><br /><br />

  <label>ç§‘ç›®ï¼š</label>
  <select id="subject"></select><br /><br />

  <input type="text" id="newSubject" placeholder="æ–°å¢ç§‘ç›®" />
  <button onclick="addNewSubject()">â• åŠ å…¥ç§‘ç›®</button><br /><br />

  <div id="subjectList"></div><br />

  <label>é æ•¸ç¯„åœï¼š</label>
  <input id="pageStart" type="number" placeholder="é–‹å§‹é " />
  ~
  <input id="pageEnd" type="number" placeholder="çµæŸé " /><br /><br />
  <button onclick="addTask()">ç™»éŒ„</button>

  <h3><a href="records.html">ğŸ“– æŸ¥çœ‹å…¨éƒ¨ç©æ¬ ä½œæ¥­</a></h3>

  <h3 style="color:red;">ğŸ”´ æ¸…é™¤æ‰€æœ‰å­¸ç”Ÿè³‡æ–™</h3>
  <button onclick="clearAllStudents()">æ¸…é™¤å­¸ç”Ÿè³‡æ–™</button>

  <br /><br />
  <button class="logout-btn" onclick="logout()">ğŸ”“ ç™»å‡º</button>

  <script>
    // Firebase è¨­å®šï¼ˆå·²æ›´æ›ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyBvjO6-SZG0TXny9RNowA7e7rRdK1Z58oE",
      authDomain: "water-7b4fe.firebaseapp.com",
      projectId: "water-7b4fe",
      storageBucket: "water-7b4fe.firebasestorage.app",
      messagingSenderId: "66478103908",
      appId: "1:66478103908:web:2e6b82f27e536181666e71"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ç™»å…¥ä¿è­·æ©Ÿåˆ¶ï¼šç¢ºèªå¸³è™Ÿå¾ accounts æ“·å–
    const currentUser = localStorage.getItem("studentNo");

    db.ref("accounts/" + currentUser).once("value").then(snapshot => {
      if (!snapshot.exists()) {
        alert("è«‹å…ˆç™»å…¥ï¼");
        window.location.href = "index.html";
      } else {
        document.body.style.display = "block";
        loadStudents();
        loadSubjects();
      }
    });

    function importExcel() {
      const file = document.getElementById("excelFile").files[0];
      if (!file) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");
      const reader = new FileReader();
      reader.onload = function (e) {
        const workbook = XLSX.read(e.target.result, { type: "binary" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet);
        data.forEach((item) => {
          const no = item.åº§è™Ÿ;
          const name = item.å§“å;
          db.ref("students/" + no).set({ no, name });
        });
        alert("åŒ¯å…¥å®Œæˆï¼");
        loadStudents();
      };
      reader.readAsBinaryString(file);
    }

    function addStudent() {
      const no = document.getElementById("no").value.trim();
      const name = document.getElementById("name").value.trim();
      if (!no || !name) return alert("è«‹å¡«å…¥åº§è™Ÿèˆ‡å§“å");
      db.ref("students/" + no).set({ no, name });
      alert("æ–°å¢æˆåŠŸ");
      document.getElementById("no").value = "";
      document.getElementById("name").value = "";
      loadStudents();
    }

    function loadStudents() {
      const select = document.getElementById("studentSelect");
      select.innerHTML = "";
      db.ref("students").once("value", (snapshot) => {
        snapshot.forEach((child) => {
          const s = child.val();
          const option = document.createElement("option");
          option.value = s.no;
          option.textContent = `${s.no} ${s.name}`;
          select.appendChild(option);
        });
      });
    }

    function loadSubjects() {
      const subjectSelect = document.getElementById("subject");
      const subjectList = document.getElementById("subjectList");
      subjectSelect.innerHTML = "";
      subjectList.innerHTML = "";

      db.ref("subjects").once("value", (snapshot) => {
        const subjects = snapshot.val() || {};
        for (let key in subjects) {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = key;
          subjectSelect.appendChild(opt);

          const div = document.createElement("div");
          div.innerHTML = `${key} <button onclick="deleteSubject('${key}')">âŒ åˆªé™¤</button>`;
          subjectList.appendChild(div);
        }
      });
    }

    function addNewSubject() {
      const newSubj = document.getElementById("newSubject").value.trim();
      if (!newSubj) return alert("è«‹è¼¸å…¥ç§‘ç›®åç¨±");
      db.ref("subjects/" + newSubj)
        .set(true)
        .then(() => {
          document.getElementById("newSubject").value = "";
          loadSubjects();
          alert("ç§‘ç›®æ–°å¢æˆåŠŸï¼");
        });
    }

    function deleteSubject(subject) {
      if (confirm(`ç¢ºå®šåˆªé™¤ç§‘ç›®ã€Œ${subject}ã€ï¼Ÿ`)) {
        db.ref("subjects/" + subject)
          .remove()
          .then(() => {
            alert("å·²åˆªé™¤ç§‘ç›®ï¼");
            loadSubjects();
          });
      }
    }

    function addTask() {
      const no = document.getElementById("studentSelect").value;
      const subject = document.getElementById("subject").value;
      const startPage = document.getElementById("pageStart").value;
      const endPage = document.getElementById("pageEnd").value;
      const date = new Date().toLocaleDateString();

      if (!no || !subject || !startPage || !endPage)
        return alert("è«‹å¡«å…¥æ‰€æœ‰æ¬„ä½");

      db.ref("students/" + no).once("value", (snapshot) => {
        const student = snapshot.val();
        const name = student.name || "";

        const task = {
          no,
          name,
          subject,
          page: `${startPage}ï½${endPage} é `,
          date,
        };

        db.ref("records")
          .push(task)
          .then(() => {
            alert("ç©æ¬ ä½œæ¥­ç™»éŒ„å®Œæˆï¼");
            document.getElementById("pageStart").value = "";
            document.getElementById("pageEnd").value = "";
          });
      });
    }

    function clearAllStudents() {
      if (confirm("âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç”Ÿè³‡æ–™å—ï¼Ÿ")) {
        db.ref("students")
          .remove()
          .then(() => {
            alert("å·²æ¸…é™¤æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ï¼");
            loadStudents();
          })
          .catch((err) => alert("æ¸…é™¤å¤±æ•—ï¼š" + err));
      }
    }

    function logout() {
      if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
        localStorage.removeItem("studentNo");
        window.location.href = "index.html";
      }
    }
  </script>
</body>
</html>
