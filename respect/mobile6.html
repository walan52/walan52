<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èª²å ‚å³æ™‚å›æ‡‰ç³»çµ±ï¼ˆå­¸ç”Ÿç«¯ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    html, body {
      height: 100%;
      -webkit-overflow-scrolling: touch;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      font-family: "å¾®è»Ÿæ­£é»‘é«”";
    }

    .box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 20px auto;
      box-sizing: border-box;
    }

    input, button, textarea {
      margin: 10px 0;
      padding: 14px;
      width: 80%;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 18px;
      box-sizing: border-box;
      font-family: "å¾®è»Ÿæ­£é»‘é«”";
    }

    button {
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover:not(:disabled) {
      background: #2980b9;
    }

    #messageBox {
      font-size: 2rem;
      font-weight: 700;
      color: #2c3e50;
      margin-top: 20px;
      user-select: none;
    }

    #scoreDisplay {
      margin-top: 15px;
      font-size: 1.3rem;
      color: #34495e;
      font-weight: 600;
    }

    #buzzBtn {
      margin-top: 15px;
      background: #e74c3c;
      font-weight: 700;
      font-size: 1.3rem;
      padding: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      user-select: none;
      display: none; /* é è¨­éš±è— */
    }

    #buzzBtn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }

    #buzzStatus {
      margin-top: 15px;
      font-weight: 700;
      color: #c0392b;
      font-size: 1.2rem;
      user-select: none;
      min-height: 1.4em;
    }

    #notice {
      margin-top: 20px;
      font-size: 1.1rem;
      color: #16a085;
      font-weight: 700;
      min-height: 1.2em;
    }

    /* éŸ¿æ‡‰å¼ï¼šå°è¢å¹•èª¿æ•´ */
    @media screen and (max-width: 600px) {
      .box {
        max-width: 95%;
        padding: 15px;
      }
      input, button, textarea, #buzzBtn {
        width: 95%;
        font-size: 1.2rem;
        padding: 14px;
      }
      #messageBox {
        font-size: 2.2rem;
      }
      #scoreDisplay {
        font-size: 1.5rem;
      }
      #buzzBtn {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="box" id="setupBox" style="display:none;">
    <h2>è«‹è¼¸å…¥åº§è™Ÿèˆ‡æš±ç¨±</h2>
    <input id="seatInput" type="number" placeholder="åº§è™Ÿ" />
    <input id="nameInput" type="text" placeholder="æš±ç¨±" />
    <button onclick="enterSystem()">é€²å…¥ç­”é¡Œ</button>
    <div id="notice"></div>
  </div>

  <div class="box" id="messageBox" style="display:none;">
    å°ˆå¿ƒä¸Šèª²ï¼Œä¸è¦æ‰“çŒç¡ ~~~
    <div id="scoreDisplay">ç›®å‰åˆ†æ•¸ï¼š0 åˆ†</div>
    <button id="buzzBtn" onclick="tryBuzz()">æ¶ç­”</button>
    <div id="buzzStatus"></div>
    <div id="notice"></div>
  </div>

  <div class="box" id="quizBox" style="display:none;">
    <h3 id="questionText">ç­‰å¾…è€å¸«å‡ºé¡Œä¸­...</h3>
    <textarea id="answerInput" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ" rows="5"></textarea>
    <button onclick="submitAnswer()">é€å‡ºç­”æ¡ˆ</button>
    <p id="scoreText"></p>
    <div id="notice"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5aW_wP20TbBPMqUeGQaPw9MH0dpRjgaQ",
      authDomain: "respect-833f3.firebaseapp.com",
      databaseURL: "https://respect-833f3-default-rtdb.firebaseio.com",
      projectId: "respect-833f3",
      storageBucket: "respect-833f3.firebasestorage.app",
      messagingSenderId: "360277137589",
      appId: "1:360277137589:web:6a7b8bf0763ef5d43446fc"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let seat = "";
    let name = "";

    // é¡¯ç¤ºæç¤ºè¨Šæ¯ï¼ˆå–ä»£ alertï¼‰
    function showNotice(msg, color="#16a085") {
      document.querySelectorAll("#notice").forEach(n => {
        n.innerText = msg;
        n.style.color = color;
      });
      setTimeout(() => {
        document.querySelectorAll("#notice").forEach(n => n.innerText = "");
      }, 3000);
    }

    async function enterSystem() {
      seat = document.getElementById("seatInput").value.trim();
      name = document.getElementById("nameInput").value.trim();
      if (!seat || !name) {
        showNotice("âš ï¸ è«‹è¼¸å…¥åº§è™Ÿèˆ‡æš±ç¨±", "#e67e22");
        return;
      }
      localStorage.setItem("seat", seat);
      localStorage.setItem("name", name);
      await setupUser();
    }

    async function setupUser() {
      // è®€å–åº§è™Ÿè³‡æ–™
      const studentRef = db.ref("students/" + seat);
      const snapshot = await studentRef.once("value");
      const data = snapshot.val();

      if (data) {
        // æœ‰è³‡æ–™ï¼Œæ›´æ–°æš±ç¨±ä½†ä¸è®Šå‹•åˆ†æ•¸
        await studentRef.update({ nickname: name });
      } else {
        // ç„¡è³‡æ–™ï¼Œå»ºç«‹æš±ç¨±åŠåˆ†æ•¸0
        await studentRef.set({ nickname: name, score: 0 });
      }

      showMainUI();
    }

    function showMainUI() {
      document.getElementById("setupBox").style.display = "none";
      document.getElementById("messageBox").style.display = "block";
      document.getElementById("quizBox").style.display = "none";

      // é¡Œç›®ç›£è½
      db.ref("questions/current").on("value", snapshot => {
        const data = snapshot.val();
        if (data && data.text && data.text.trim() !== "") {
          document.getElementById("questionText").innerText = data.text;
          document.getElementById("quizBox").style.display = "block";
          document.getElementById("messageBox").style.display = "none";
        } else {
          document.getElementById("quizBox").style.display = "none";
          document.getElementById("messageBox").style.display = "block";
          hideBuzzButton();
          clearBuzzStatus();
        }
      });

      // åˆ†æ•¸ç›£è½
      db.ref("students/" + seat + "/score").on("value", s => {
        const score = s.val() || 0;
        document.getElementById("scoreText").innerText = "ç›®å‰åˆ†æ•¸ï¼š" + score + " åˆ†";
        document.getElementById("scoreDisplay").innerText = "ç›®å‰åˆ†æ•¸ï¼š" + score + " åˆ†";
      });

      // æ¶ç­”ç‹€æ…‹ç›£è½
      db.ref("buzzing").on("value", snap => {
        const buzzSeat = snap.val();
        if (buzzSeat === "countdown") {
          hideBuzzButton();
          document.getElementById("buzzStatus").innerText = "æ¶ç­”å€’æ•¸ä¸­ï¼Œè«‹ç¨å¾Œ...";
        } else if (!buzzSeat) {
          showBuzzButton(true);
          document.getElementById("buzzStatus").innerText = "ç¾åœ¨å¯ä»¥æ¶ç­”ï¼";
        } else if (buzzSeat === seat) {
          showBuzzButton(false);
          document.getElementById("buzzStatus").innerText = "ä½ å·²æˆåŠŸæ¶ç­”ï¼è«‹æº–å‚™å›ç­”ã€‚";
        } else {
          showBuzzButton(false);
          document.getElementById("buzzStatus").innerText = `åº§è™Ÿ ${buzzSeat} å·²æ¶ç­”ï¼Œè«‹ç­‰å¾…è€å¸«é‡ç½®æ¶ç­”ã€‚`;
        }
      });

      // Firebase é€£ç·šç›£æ¸¬
      db.ref(".info/connected").on("value", snap => {
        if (snap.val() === false) {
          showNotice("âš ï¸ å·²é›¢ç·šï¼Œå°‡è‡ªå‹•é‡è©¦é€£ç·š", "#e74c3c");
        } else {
          showNotice("âœ… å·²é‡æ–°é€£ç·šï¼");
        }
      });
    }

    function showBuzzButton(enabled) {
      const btn = document.getElementById("buzzBtn");
      btn.style.display = "inline-block";
      btn.disabled = !enabled;
    }

    function hideBuzzButton() {
      const btn = document.getElementById("buzzBtn");
      btn.style.display = "none";
      btn.disabled = true;
    }

    function clearBuzzStatus() {
      document.getElementById("buzzStatus").innerText = "";
    }

    function tryBuzz() {
      db.ref("buzzing").transaction(currentValue => {
        if (!currentValue) return seat;
        return;
      }, (error, committed) => {
        if (error) {
          showNotice("æ¶ç­”å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "#e74c3c");
        } else if (!committed) {
          showNotice("å·²æœ‰äººæ¶ç­”ï¼Œè«‹ç­‰å¾…è€å¸«é‡ç½®", "#e67e22");
        } else {
          showNotice("ğŸ‰ æ­å–œä½ ï¼Œæ¶ç­”æˆåŠŸï¼");
        }
      });
    }

    function submitAnswer() {
      const answer = document.getElementById("answerInput").value.trim();
      if (!answer) {
        showNotice("è«‹è¼¸å…¥ç­”æ¡ˆ", "#e67e22");
        return;
      }
      db.ref("students/" + seat + "/answer").set(answer).then(() => {
        showNotice("âœ… å·²é€å‡ºï¼");
        document.getElementById("answerInput").value = "";
        document.getElementById("quizBox").style.display = "none";
        document.getElementById("messageBox").style.display = "block";
      });
    }

    window.onload = () => {
      // å˜—è©¦å¾ localStorage è®€åº§è™Ÿå’Œæš±ç¨±
      const savedSeat = localStorage.getItem("seat");
      const savedName = localStorage.getItem("name");
      if (savedSeat && savedName) {
        seat = savedSeat;
        name = savedName;
        setupUser();
      } else {
        // æ²’æœ‰è³‡æ–™å°±é¡¯ç¤ºè¼¸å…¥ç•«é¢
        document.getElementById("setupBox").style.display = "block";
      }
    };
  </script>
</body>
</html>
