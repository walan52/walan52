<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>課堂即時回應系統（學生端）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: "微軟正黑體";
      background: #f9f9f9;
      padding: 15px 10px;
      text-align: center;
      margin: 0;
    }
    .box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 20px auto 0 auto;
      box-sizing: border-box;
    }
    input, button, textarea {
      margin: 10px 0;
      padding: 12px;
      width: 80%;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1.1rem;
      box-sizing: border-box;
      font-family: "微軟正黑體";
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background: #2980b9;
    }
    #messageBox {
      font-size: 2rem;
      font-weight: 700;
      color: #2c3e50;
      margin-top: 20px;
      user-select: none;
    }
    #scoreDisplay {
      margin-top: 15px;
      font-size: 1.3rem;
      color: #34495e;
      font-weight: 600;
    }
    #buzzBtn {
      margin-top: 15px;
      background: #e74c3c;
      font-weight: 700;
      font-size: 1.3rem;
      padding: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      user-select: none;
    }
    #buzzBtn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    #buzzStatus {
      margin-top: 15px;
      font-weight: 700;
      color: #c0392b;
      font-size: 1.2rem;
      user-select: none;
    }
    /* 響應式：小螢幕調整 */
    @media screen and (max-width: 600px) {
      .box {
        max-width: 95%;
        padding: 15px;
      }
      input, button, textarea, #buzzBtn {
        width: 95%;
        font-size: 1.2rem;
        padding: 14px;
      }
      #messageBox {
        font-size: 2.2rem;
      }
      #scoreDisplay {
        font-size: 1.5rem;
      }
      #buzzBtn {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="box" id="setupBox">
    <h2>請輸入座號與暱稱</h2>
    <input id="seatInput" type="number" placeholder="座號" />
    <input id="nameInput" type="text" placeholder="暱稱" />
    <button onclick="enterSystem()">進入答題</button>
  </div>

  <div class="box" id="messageBox" style="display:none;">
    專心上課，不要打瞌睡 ~~~
    <div id="scoreDisplay">目前分數：0 分</div>
    <button id="buzzBtn" style="display:none;" onclick="tryBuzz()">搶答</button>
    <div id="buzzStatus"></div>
  </div>

  <div class="box" id="quizBox" style="display:none;">
    <h3 id="questionText">等待老師出題中...</h3>
    <textarea id="answerInput" placeholder="請輸入答案" rows="5"></textarea>
    <button onclick="submitAnswer()">送出答案</button>
    <p id="scoreText"></p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5aW_wP20TbBPMqUeGQaPw9MH0dpRjgaQ",
      authDomain: "respect-833f3.firebaseapp.com",
      databaseURL: "https://respect-833f3-default-rtdb.firebaseio.com",
      projectId: "respect-833f3",
      storageBucket: "respect-833f3.firebasestorage.app",
      messagingSenderId: "360277137589",
      appId: "1:360277137589:web:6a7b8bf0763ef5d43446fc"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let seat = "";
    let name = "";

    function enterSystem() {
      seat = document.getElementById("seatInput").value.trim();
      name = document.getElementById("nameInput").value.trim();
      if (!seat || !name) {
        alert("請輸入座號與暱稱");
        return;
      }

      document.getElementById("setupBox").style.display = "none";
      document.getElementById("messageBox").style.display = "block";
      document.getElementById("quizBox").style.display = "none";

      db.ref("students/" + seat).update({
        nickname: name,
        score: 0
      });

      // 監聽題目
      db.ref("questions/current").on("value", snapshot => {
        const data = snapshot.val();

        if (data && data.text && data.text.trim() !== "") {
          document.getElementById("questionText").innerText = data.text;
          document.getElementById("quizBox").style.display = "block";
          document.getElementById("messageBox").style.display = "none";
          // 搶答按鈕顯示判斷交給搶答狀態監聽
        } else {
          document.getElementById("quizBox").style.display = "none";
          document.getElementById("messageBox").style.display = "block";
          document.getElementById("buzzBtn").style.display = "none";
          document.getElementById("buzzStatus").innerText = "";
        }
      });

      // 監聽分數
      db.ref("students/" + seat + "/score").on("value", s => {
        const score = s.val() || 0;
        document.getElementById("scoreText").innerText = "目前分數：" + score + " 分";
        document.getElementById("scoreDisplay").innerText = "目前分數：" + score + " 分";
      });

      // 監聽搶答狀態
      db.ref("buzzing").on("value", snap => {
        const buzzSeat = snap.val();
        if (!buzzSeat) {
          // 沒人搶答，搶答按鈕可用
          document.getElementById("buzzBtn").disabled = false;
          document.getElementById("buzzBtn").style.display = "inline-block";
          document.getElementById("buzzStatus").innerText = "現在可以搶答！";
        } else if (buzzSeat === seat) {
          // 自己是搶答者，顯示搶答成功訊息
          document.getElementById("buzzBtn").disabled = true;
          document.getElementById("buzzBtn").style.display = "inline-block";
          document.getElementById("buzzStatus").innerText = "你已成功搶答！請準備回答。";
        } else {
          // 其他人搶答中，禁用按鈕並顯示搶答者座號
          document.getElementById("buzzBtn").disabled = true;
          document.getElementById("buzzBtn").style.display = "inline-block";
          document.getElementById("buzzStatus").innerText = `座號 ${buzzSeat} 已搶答，請等待老師重置搶答。`;
        }
      });
    }

    // 學生搶答按鈕事件
    function tryBuzz() {
      // 先讀取搶答狀態，確保沒人搶答再寫入
      db.ref("buzzing").transaction(currentValue => {
        if (!currentValue) {
          return seat; // 寫入自己的座號
        }
        return; // 有人搶答中，不更新
      }, (error, committed, snapshot) => {
        if (error) {
          alert("搶答失敗，請稍後再試");
        } else if (!committed) {
          alert("已有人搶答，請等待老師重置");
        } else {
          alert("恭喜你，搶答成功！");
        }
      });
    }

    function submitAnswer() {
      const answer = document.getElementById("answerInput").value.trim();
      if (!answer) {
        alert("請輸入答案");
        return;
      }
      db.ref("students/" + seat + "/answer").set(answer).then(() => {
        alert("已送出！");
        document.getElementById("answerInput").value = "";
        document.getElementById("quizBox").style.display = "none";
        document.getElementById("messageBox").style.display = "block";
        // 搶答送出後，老師可決定是否清除搶答狀態
      });
    }
  </script>
</body>
</html>
