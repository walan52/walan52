<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èª²å ‚å›é¥‹ï¼ˆæ•™å¸«ç«¯ï¼‰</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: "å¾®è»Ÿæ­£é»‘é«”";
      background: #eef;
      padding: 20px;
    }
    h2 { text-align: center; color: #2c3e50; font-size: 28px; }
    label { font-size: 20px; font-weight: bold; margin-right: 8px; }
    input {
      width: 40%; padding: 8px; font-size: 18px;
      border-radius: 6px; border: 1px solid #ccc;
    }
    button {
      padding: 6px 14px; border: none; background: #27ae60; color: white;
      border-radius: 6px; cursor: pointer; font-size: 18px; margin-left: 6px;
    }
    button:hover { background: #1e8449; }

    .stop-btn { background: #e67e22; }
    .stop-btn:hover { background: #ca6f1e; }

    .minus-btn { background: #e74c3c; }
    .minus-btn:hover { background: #c0392b; }

    .container { display: flex; justify-content: space-between; gap: 20px; margin-top: 20px; }
    .table-container {
      flex: 1; max-height: 70vh; overflow-y: auto;
      border: 2px solid #aaa; border-radius: 8px; background: white;
    }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border: 1px solid #ccc; padding: 10px 6px; text-align: center; word-wrap: break-word; }
    th {
      background: #dfe6e9; position: sticky; top: 0; z-index: 2;
      font-size: 20px;
    }
    td { font-size: 20px; }
    td:nth-child(3) {
      font-size: 24px; font-weight: bold; color: #2c3e50;
    }
    #buzzStatus { margin-top: 20px; font-size: 20px; font-weight: 700; color: #e74c3c; }
    #countdown { font-size: 20px; font-weight: 700; color: #2980b9; margin-top: 10px; }
  </style>
</head>

<body>

<script>
  /* -----------------------------------------------------------
     ğŸ”’ã€ç™»å…¥æª¢æŸ¥ â€“ æœªç™»å…¥ä¸å¯é€²å…¥ teacher.htmlã€‘ 
     ----------------------------------------------------------- */

  if (!localStorage.getItem("teacherLogin") || localStorage.getItem("teacherLogin") !== "yes") {
    alert("è«‹å…ˆç™»å…¥ï¼");
    window.location.href = "login.html";
  }
</script>

  <h2>èª²å ‚å³æ™‚ç­”é¡Œç‹€æ³</h2>

  <label>é¡Œç›®ï¼š</label>
  <input id="questionInput" placeholder="è¼¸å…¥è€å¸«è¦å•çš„å•é¡Œ" />
  <button onclick="sendQuestion()">ç™¼é€é¡Œç›®</button>
  <button class="stop-btn" onclick="stopQuestion()">ğŸ›‘ åœæ­¢ä½œç­”</button>
  <button onclick="toggleAnswer()" id="toggleBtn">é¡¯ç¤ºç­”æ¡ˆ</button>

  <button onclick="exportToExcel()">åŒ¯å‡ºExcel</button>
  <button onclick="clearAnswers()">æ¸…é™¤ç­”æ¡ˆ</button>
  <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰å­¸ç”Ÿè³‡æ–™</button>

  <div style="margin-top:15px;">
    <button onclick="startCountdown()" id="startBuzzBtn">å•Ÿå‹•æ¶ç­”å€’æ•¸ï¼ˆ5ç§’ï¼‰</button>
    <button onclick="resetBuzz()">é‡ç½®æ¶ç­”</button>
    <div id="buzzStatus">ç›®å‰ç„¡äººæ¶ç­”</div>
    <div id="countdown"></div>
  </div>

  <div class="container">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>åº§è™Ÿ</th>
            <th>æš±ç¨±</th>
            <th>ç­”æ¡ˆ</th>
            <th>åˆ†æ•¸</th>
            <th>åŠ ï¼æ‰£åˆ†</th>
          </tr>
        </thead>
        <tbody id="leftTable"></tbody>
      </table>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>åº§è™Ÿ</th>
            <th>æš±ç¨±</th>
            <th>ç­”æ¡ˆ</th>
            <th>åˆ†æ•¸</th>
            <th>åŠ ï¼æ‰£åˆ†</th>
          </tr>
        </thead>
        <tbody id="rightTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5aW_wP20TbBPMqUeGQaPw9MH0dpRjgaQ",
      authDomain: "respect-833f3.firebaseapp.com",
      databaseURL: "https://respect-833f3-default-rtdb.firebaseio.com",
      projectId: "respect-833f3",
      storageBucket: "respect-833f3.appspot.com",
      messagingSenderId: "360277137589",
      appId: "1:360277137589:web:6a7b8bf0763ef5d43446fc",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let showAnswer = false;

    function toggleAnswer() {
      showAnswer = !showAnswer;
      document.getElementById("toggleBtn").innerText =
        showAnswer ? "éš±è—ç­”æ¡ˆ" : "é¡¯ç¤ºç­”æ¡ˆ";

      db.ref("students").once("value").then((snap) => {
        renderTables(snap.val() || {});
      });
    }

    function sendQuestion() {
      const text = document.getElementById("questionInput").value.trim();
      if (!text) return alert("è«‹è¼¸å…¥å•é¡Œ");
      db.ref("questions/current").set({ text });
      document.getElementById("questionInput").value = "";
    }

    function stopQuestion() {
      db.ref("questions/current").remove().then(() => {
        alert("é¡Œç›®å·²æ¸…é™¤ï¼Œåœæ­¢ä½œç­”ï¼");
      });
    }

    db.ref("students").on("value", (snap) => {
      renderTables(snap.val() || {});
    });

    db.ref("buzzing").on("value", (snap) => {
      const buzzSeat = snap.val();
      if (!buzzSeat || buzzSeat === "countdown") {
        document.getElementById("buzzStatus").innerText =
          buzzSeat === "countdown" ? "æ¶ç­”å€’æ•¸ä¸­..." : "ç›®å‰ç„¡äººæ¶ç­”";
      } else {
        db.ref("students/" + buzzSeat + "/nickname")
          .once("value")
          .then((snap) => {
            const nick = snap.val() || "";
            document.getElementById("buzzStatus").innerText =
              `æ¶ç­”è€…ï¼šåº§è™Ÿ ${buzzSeat}ï¼Œæš±ç¨± ${nick}`;
          });
      }
    });

    let countdownInterval = null;

    function startCountdown() {
      if (countdownInterval) return;

      let sec = 5;
      document.getElementById("countdown").innerText = `æ¶ç­”å€’æ•¸ï¼š${sec} ç§’`;
      document.getElementById("startBuzzBtn").disabled = true;
      db.ref("buzzing").set("countdown");

      countdownInterval = setInterval(() => {
        sec--;
        if (sec > 0) {
          document.getElementById("countdown").innerText = `æ¶ç­”å€’æ•¸ï¼š${sec} ç§’`;
        } else {
          clearInterval(countdownInterval);
          countdownInterval = null;
          document.getElementById("countdown").innerText = "æ¶ç­”é–‹å§‹ï¼";
          document.getElementById("startBuzzBtn").disabled = false;
          db.ref("buzzing").remove();
        }
      }, 1000);
    }

    function renderTables(data) {
      const left = document.getElementById("leftTable");
      const right = document.getElementById("rightTable");
      left.innerHTML = "";
      right.innerHTML = "";

      const sorted = Object.keys(data).sort((a, b) => Number(a) - Number(b));

      sorted.forEach((seat) => {
        const s = data[seat];
        const row = document.createElement("tr");

        const answerDisplay = showAnswer ? (s.answer || "") : "â—â—â—";

        row.innerHTML = `
          <td>${seat}</td>
          <td>${s.nickname || ""}</td>
          <td>${answerDisplay}</td>
          <td>${s.score || 0}</td>
          <td>
            <button onclick="addPoint('${seat}', ${s.score || 0})">+1</button>
            <button class="minus-btn" onclick="minusPoint('${seat}', ${s.score || 0})">âˆ’1</button>
          </td>
        `;

        if (Number(seat) <= 10) left.appendChild(row);
        else right.appendChild(row);
      });
    }

    function addPoint(seat, score) {
      db.ref("students/" + seat + "/score").set(score + 1);
    }

    function minusPoint(seat, score) {
      const newScore = score > 0 ? score - 1 : 0;
      db.ref("students/" + seat + "/score").set(newScore);
    }

    function exportToExcel() {
      db.ref("students").once("value").then((snap) => {
        const data = snap.val() || {};
        const sorted = Object.keys(data).sort((a, b) => Number(a) - Number(b));

        const exportData = [["åº§è™Ÿ", "æš±ç¨±", "ç­”æ¡ˆ", "åˆ†æ•¸"]];
        sorted.forEach((seat) => {
          const s = data[seat];
          exportData.push([seat, s.nickname || "", s.answer || "", s.score || 0]);
        });

        const ws = XLSX.utils.aoa_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "å­¸ç”Ÿç­”é¡Œè³‡æ–™");
        XLSX.writeFile(wb, "å­¸ç”Ÿç­”é¡Œè³‡æ–™.xlsx");
      });
    }

    function clearAnswers() {
      db.ref("students").once("value").then((snap) => {
        const data = snap.val() || {};
        const updates = {};
        Object.keys(data).forEach((seat) => {
          updates[seat + "/answer"] = null;
        });

        Promise.all([
          db.ref("students").update(updates),
          db.ref("questions/current").remove(),
          db.ref("buzzing").remove(),
        ]).then(() => {
          alert("æ‰€æœ‰å­¸ç”Ÿç­”æ¡ˆã€é¡Œç›®èˆ‡æ¶ç­”ç‹€æ…‹å·²æ¸…é™¤ï¼");
          document.getElementById("countdown").innerText = "";
        });
      });
    }

    function clearAllData() {
      if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç”Ÿè³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•é‚„åŸï¼")) return;

      Promise.all([
        db.ref("students").remove(),
        db.ref("questions/current").remove(),
        db.ref("buzzing").remove(),
      ]).then(() => {
        alert("æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ã€é¡Œç›®èˆ‡æ¶ç­”ç‹€æ…‹å·²æ¸…é™¤ï¼");
        document.getElementById("countdown").innerText = "";
      });
    }

    function resetBuzz() {
      db.ref("buzzing").remove().then(() => {
        alert("æ¶ç­”ç‹€æ…‹å·²é‡ç½®");
        document.getElementById("countdown").innerText = "";
      });
    }
  </script>

</body>
</html>
