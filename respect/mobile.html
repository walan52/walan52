<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èª²å ‚å³æ™‚å›æ‡‰ç³»çµ±ï¼ˆå­¸ç”Ÿç«¯ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    html, body {
      height: 100%;
      -webkit-overflow-scrolling: touch;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      font-family: "å¾®è»Ÿæ­£é»‘é«”";
    }
    .box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 20px auto;
      box-sizing: border-box;
    }
    input, button, textarea {
      margin: 10px 0;
      padding: 14px;
      width: 80%;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 18px;
      box-sizing: border-box;
      font-family: "å¾®è»Ÿæ­£é»‘é«”";
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover:not(:disabled) { background: #2980b9; }
    #messageBox { font-size: 2rem; font-weight: 700; color: #2c3e50; margin-top: 20px; user-select: none; }
    #scoreDisplay { margin-top: 15px; font-size: 1.3rem; color: #34495e; font-weight: 600; }

    /* åŠ å¤§æ¶ç­”å€å¡Šåº•éƒ¨é–“è· */
    .buzz-section {
      margin-bottom: 60px; /* ç”± 30px æ”¹æˆ 60px */
    }
    .card-logout-section button {
      display: block;
      margin: 10px auto; /* æŒ‰éˆ•å‚ç›´æ’åˆ—ä¸”ç½®ä¸­ */
      width: 80%;
    }

    /* æ¶ç­”æŒ‰éˆ•æ”¹ç‚ºæ›´å¤§åœ“å½¢ */
    #buzzBtn {
      margin-top: 15px;
      background: #e74c3c;
      font-weight: 700;
      font-size: 1.7rem;
      padding: 0;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      user-select: none;
      display: none;
      line-height: 140px;
      text-align: center;
      color: white;
    }
    #buzzBtn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    #buzzStatus {
      margin-top: 15px;
      font-weight: 700;
      color: #c0392b;
      font-size: 1.2rem;
      user-select: none;
      min-height: 1.4em;
    }
    #buzzCountdown {
      margin-top: 8px;
      font-weight: 700;
      font-size: 1.2rem;
      color: #d35400;
      user-select: none;
      min-height: 1.2em;
    }
    #notice {
      margin-top: 20px;
      font-size: 1.1rem;
      color: #16a085;
      font-weight: 700;
      min-height: 1.2em;
    }
    #drawCardBtn {
      background: #9b59b6;
      font-weight: 700;
      font-size: 1.3rem;
      padding: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      display: none;
      color: white;
    }
    #drawTenBtn {
      background: #f1c40f;
      font-weight: 700;
      font-size: 1.3rem;
      padding: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      display: none;
      color: black;
    }
    #logoutBtn {
      background: #e67e22;
      font-weight: 700;
      font-size: 1rem;
      padding: 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      user-select: none;
      display: none;
      width: 80%;
      margin-top: 10px;
      color: white;
    }

    /* æ–°å¢æŠ½å¡æŸ¥è©¢å€åŸŸ */
    #drawHistoryBox {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 15px;
      padding: 10px;
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      color: #555;
      text-align: left;
    }
    #drawHistoryBox h4 {
      margin: 0 0 10px 0;
      font-weight: 700;
      color: #9b59b6;
    }
    #drawHistoryBox ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      max-height: 180px;
      overflow-y: auto;
    }
    #drawHistoryBox li {
      margin-bottom: 6px;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }

    @media screen and (max-width: 600px) {
      .box { max-width: 95%; padding: 15px; }
      input, button, textarea, #buzzBtn { width: 95%; font-size: 1.2rem; padding: 14px; }
      #messageBox { font-size: 2.2rem; }
      #scoreDisplay { font-size: 1.5rem; }
      #buzzBtn { font-size: 1.4rem; width: 110px; height: 110px; line-height: 110px; }
      #drawCardBtn, #drawTenBtn, #logoutBtn {
        width: 95%;
        font-size: 1.5rem;
      }
    }
  </style>
</head>

<body>

<div class="box" id="setupBox" style="display:none;">
  <h2>è«‹è¼¸å…¥åº§è™Ÿèˆ‡æš±ç¨±</h2>
  <input id="seatInput" type="number" placeholder="åº§è™Ÿ" />
  <input id="nameInput" type="text" placeholder="æš±ç¨±" />
  <button onclick="enterSystem()">é€²å…¥ç­”é¡Œ</button>
  <div id="notice"></div>
</div>

<div class="box" id="messageBox" style="display:none;">
  å°ˆå¿ƒä¸Šèª²ï¼Œä¸è¦æ‰“çŒç¡ ~~~

  <div id="scoreDisplay">ç›®å‰åˆ†æ•¸ï¼š0 åˆ†</div>

  <div class="buzz-section">
    <button id="buzzBtn" onclick="tryBuzz()">æ¶ç­”</button>
    <div id="buzzStatus"></div>
    <div id="buzzCountdown"></div>
  </div>

  <div class="card-logout-section">
    <button id="drawCardBtn" onclick="drawCard()">æŠ½å¡ï¼ˆæ‰£ 10 åˆ†ï¼‰</button>
    <button id="drawTenBtn" onclick="drawTen()">åé€£æŠ½ï¼ˆæ‰£ 100 åˆ†ï¼‰</button>
    <button id="logoutBtn" onclick="logout()">ç™»å‡º</button>
  </div>

  <!-- æŠ½å¡æŸ¥è©¢å€ -->
  <div id="drawHistoryBox" style="display:none;">
    <h4>ä½ çš„æŠ½å¡ç´€éŒ„</h4>
    <ul id="drawHistoryList">
      <!-- å‹•æ…‹ç”¢ç”Ÿ -->
    </ul>
  </div>

  <div id="notice"></div>
</div>

<div class="box" id="quizBox" style="display:none;">
  <h3 id="questionText">ç­‰å¾…è€å¸«å‡ºé¡Œä¸­...</h3>
  <textarea id="answerInput" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ" rows="5"></textarea>
  <button onclick="submitAnswer()">é€å‡ºç­”æ¡ˆ</button>
  <p id="scoreText"></p>
  <div id="notice"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC5aW_wP20TbBPMqUeGQaPw9MH0dpRjgaQ",
  authDomain: "respect-833f3.firebaseapp.com",
  databaseURL: "https://respect-833f3-default-rtdb.firebaseio.com",
  projectId: "respect-833f3",
  storageBucket: "respect-833f3.firebasestorage.app",
  messagingSenderId: "360277137589",
  appId: "1:360277137589:web:6a7b8bf0763ef5d43446fc"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let seat = "";
let name = "";

let buzzCountdownTimer = null;
let buzzCountdownValue = 0;

function showNotice(msg, color="#16a085") {
  document.querySelectorAll("#notice").forEach(n => {
    n.innerText = msg;
    n.style.color = color;
  });
  setTimeout(() => {
    document.querySelectorAll("#notice").forEach(n => n.innerText = "");
  }, 4000);
}

async function enterSystem() {
  seat = document.getElementById("seatInput").value.trim();
  name = document.getElementById("nameInput").value.trim();

  if (!seat || !name) {
    showNotice("âš ï¸ è«‹è¼¸å…¥åº§è™Ÿèˆ‡æš±ç¨±", "#e67e22");
    return;
  }

  localStorage.setItem("seat", seat);
  localStorage.setItem("name", name);

  await setupUser();
}

async function setupUser() {
  const studentRef = db.ref("students/" + seat);
  const snapshot = await studentRef.once("value");
  const data = snapshot.val();

  if (data) {
    await studentRef.update({ nickname: name });
  } else {
    await studentRef.set({
      nickname: name,
      score: 0
    });
  }

  showMainUI();
  loadDrawHistory();
}

function showMainUI() {
  document.getElementById("setupBox").style.display = "none";
  document.getElementById("messageBox").style.display = "block";
  document.getElementById("quizBox").style.display = "none";
  document.getElementById("logoutBtn").style.display = "inline-block";

  // é¡¯ç¤ºé¡Œç›®æˆ–ä¼‘æ¯ç•«é¢
  db.ref("questions/current").on("value", snapshot => {
    const data = snapshot.val();
    if (data && data.text && data.text.trim() !== "") {
      document.getElementById("questionText").innerText = data.text;
      document.getElementById("quizBox").style.display = "block";
      document.getElementById("messageBox").style.display = "none";
    } else {
      document.getElementById("quizBox").style.display = "none";
      document.getElementById("messageBox").style.display = "block";
      hideBuzzButton();
      clearBuzzStatus();
      clearBuzzCountdown();
    }
  });

  // åˆ†æ•¸ç›£è½ï¼ˆæ±ºå®šæ˜¯å¦é¡¯ç¤ºæŠ½å¡æŒ‰éˆ•ï¼åé€£æŠ½æŒ‰éˆ•ï¼‰
  db.ref("students/" + seat + "/score").on("value", s => {
    const score = s.val() || 0;
    document.getElementById("scoreText").innerText = "ç›®å‰åˆ†æ•¸ï¼š" + score + " åˆ†";
    document.getElementById("scoreDisplay").innerText = "ç›®å‰åˆ†æ•¸ï¼š" + score + " åˆ†";

    const drawBtn = document.getElementById("drawCardBtn");
    const tenBtn = document.getElementById("drawTenBtn");

    drawBtn.style.display = score >= 10 ? "inline-block" : "none";
    tenBtn.style.display = score >= 100 ? "inline-block" : "none";
  });

  // æ¶ç­”ç‹€æ…‹èˆ‡å€’æ•¸è¨ˆæ™‚
  db.ref("buzzing").on("value", snap => {
    const buzzSeat = snap.val();

    if (buzzSeat === "countdown") {
      hideBuzzButton();
      document.getElementById("buzzStatus").innerText = "æ¶ç­”å€’æ•¸ä¸­ï¼Œè«‹ç¨å¾Œ...";
      startBuzzCountdown(5); // å€’æ•¸ 5 ç§’
    } else {
      clearBuzzCountdown();
      if (!buzzSeat) {
        showBuzzButton(true);
        document.getElementById("buzzStatus").innerText = "ç¾åœ¨å¯ä»¥æ¶ç­”ï¼";
      } else if (buzzSeat === seat) {
        showBuzzButton(false);
        document.getElementById("buzzStatus").innerText = "ä½ å·²æˆåŠŸæ¶ç­”ï¼è«‹æº–å‚™å›ç­”ã€‚";
      } else {
        showBuzzButton(false);
        document.getElementById("buzzStatus").innerText = `åº§è™Ÿ ${buzzSeat} å·²æ¶ç­”ï¼Œè«‹ç­‰å¾…è€å¸«é‡ç½®æ¶ç­”ã€‚`;
      }
    }
  });
}

function startBuzzCountdown(seconds) {
  clearBuzzCountdown();
  buzzCountdownValue = seconds;
  updateBuzzCountdownText();

  buzzCountdownTimer = setInterval(() => {
    buzzCountdownValue--;
    if (buzzCountdownValue <= 0) {
      clearBuzzCountdown();
      document.getElementById("buzzCountdown").innerText = "";
    } else {
      updateBuzzCountdownText();
    }
  }, 1000);
}

function updateBuzzCountdownText() {
  document.getElementById("buzzCountdown").innerText = `å€’æ•¸æ™‚é–“ï¼š${buzzCountdownValue} ç§’`;
}

function clearBuzzCountdown() {
  if (buzzCountdownTimer) {
    clearInterval(buzzCountdownTimer);
    buzzCountdownTimer = null;
  }
  document.getElementById("buzzCountdown").innerText = "";
}

function showBuzzButton(enabled) {
  const btn = document.getElementById("buzzBtn");
  btn.style.display = "inline-block";
  btn.disabled = !enabled;
}

function hideBuzzButton() {
  const btn = document.getElementById("buzzBtn");
  btn.style.display = "none";
  btn.disabled = true;
}

function clearBuzzStatus() {
  document.getElementById("buzzStatus").innerText = "";
}

function tryBuzz() {
  db.ref("buzzing").transaction(currentValue => {
    if (!currentValue) return seat;
    return;
  }, (error, committed) => {
    if (error) {
      showNotice("æ¶ç­”å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "#e74c3c");
    } else if (!committed) {
      showNotice("å·²æœ‰äººæ¶ç­”ï¼Œè«‹ç­‰å¾…è€å¸«é‡ç½®", "#e67e22");
    } else {
      showNotice("ğŸ‰ æ­å–œä½ ï¼Œæ¶ç­”æˆåŠŸï¼");
    }
  });
}

function submitAnswer() {
  const answer = document.getElementById("answerInput").value.trim();

  if (!answer) {
    showNotice("è«‹è¼¸å…¥ç­”æ¡ˆ", "#e67e22");
    return;
  }

  db.ref("students/" + seat + "/answer").set(answer).then(() => {
    showNotice("âœ… å·²é€å‡ºï¼");
    document.getElementById("answerInput").value = "";
    document.getElementById("quizBox").style.display = "none";
    document.getElementById("messageBox").style.display = "block";
  });
}

/* å–®æŠ½ï¼šæ‰£ 10 åˆ† */
function drawCard() {
  const scoreRef = db.ref("students/" + seat + "/score");

  scoreRef.transaction(score => {
    if (!score || score < 10) return score;
    return score - 10;
  }, async (err, committed) => {
    if (!committed) {
      showNotice("âš ï¸ åˆ†æ•¸ä¸è¶³ï¼Œç„¡æ³•æŠ½å¡", "#e74c3c");
      return;
    }

    const cardPoolSnapshot = await db.ref("cardPool").once("value");
    const cardPoolData = cardPoolSnapshot.val();
    if (!cardPoolData) {
      showNotice("âš ï¸ å¡æ± å°šæœªè¨­å®šï¼Œè«‹è¯çµ¡è€å¸«", "#e74c3c");
      return;
    }

    const cards = Object.values(cardPoolData);
    const result = cards[Math.floor(Math.random() * cards.length)];

    const recordRef = db.ref("drawRecords").push();
    await recordRef.set({
      seat,
      nickname: name,
      card: result,
      timestamp: Date.now()
    });

    showNotice(`ğŸ´ æŠ½åˆ°ï¼š${result}ï¼ˆå·²æ‰£ 10 åˆ†ï¼‰`, "#9b59b6");
    loadDrawHistory();
  });
}

/* åé€£æŠ½ï¼šæ‰£ 100 åˆ† + ä¿åº•è‡³å°‘ 1 é‡‘ & 1 ç‰¹æ®Š */
async function drawTen() {
  const scoreRef = db.ref("students/" + seat + "/score");

  scoreRef.transaction(score => {
    if (!score || score < 100) return score;
    return score - 100;
  }, async (err, committed) => {
    if (!committed) {
      showNotice("âš ï¸ åˆ†æ•¸ä¸è¶³ï¼Œç„¡æ³•åé€£æŠ½", "#e74c3c");
      return;
    }

    const cardPoolSnapshot = await db.ref("cardPool").once("value");
    const cardPool = cardPoolSnapshot.val();
    if (!cardPool) {
      showNotice("âš ï¸ å¡æ± å°šæœªè¨­å®šï¼Œè«‹è¯çµ¡è€å¸«", "#e74c3c");
      return;
    }

    const cards = Object.values(cardPool);
    let results = [];

    // å…ˆæŠ½ 10 å¼µ
    for (let i = 0; i < 10; i++) {
      results.push(cards[Math.floor(Math.random() * cards.length)]);
    }

    // ä¿åº•ï¼šé‡‘å¡è‡³å°‘ 1 å¼µ
    if (!results.some(c => c.includes("é‡‘"))) {
      const goldCards = cards.filter(c => c.includes("é‡‘"));
      if (goldCards.length > 0)
        results[0] = goldCards[Math.floor(Math.random() * goldCards.length)];
    }

    // ä¿åº•ï¼šç‰¹æ®Šå¡è‡³å°‘ 1 å¼µ
    if (!results.some(c => c.includes("ç‰¹"))) {
      const specialCards = cards.filter(c => c.includes("ç‰¹"));
      if (specialCards.length > 0)
        results[1] = specialCards[Math.floor(Math.random() * specialCards.length)];
    }

    const recordRef = db.ref("drawRecords").push();
    await recordRef.set({
      seat,
      nickname: name,
      cards: results,
      timestamp: Date.now()
    });

    showNotice(`ğŸ‰ åé€£æŠ½å®Œæˆï¼ˆå·²æ‰£ 100 åˆ†ï¼‰`, "#f1c40f");
    loadDrawHistory();
  });
}

/* ç™»å‡º */
function logout() {
  localStorage.removeItem("seat");
  localStorage.removeItem("name");
  location.reload();
}

/* è¼‰å…¥æŠ½å¡ç´€éŒ„ */
async function loadDrawHistory() {
  const historyBox = document.getElementById("drawHistoryBox");
  const listEl = document.getElementById("drawHistoryList");
  listEl.innerHTML = "";
  historyBox.style.display = "block";

  const snapshot = await db.ref("drawRecords").orderByChild("seat").equalTo(seat).limitToLast(20).once("value");
  const records = snapshot.val();

  if (!records) {
    listEl.innerHTML = "<li>å°šç„¡æŠ½å¡ç´€éŒ„</li>";
    return;
  }

  const entries = Object.values(records).sort((a, b) => b.timestamp - a.timestamp);

  for (const rec of entries) {
    let text = "";
    if (rec.card) {
      text = `${new Date(rec.timestamp).toLocaleString()} - æŠ½åˆ°: ${rec.card}`;
    } else if (rec.cards) {
      text = `${new Date(rec.timestamp).toLocaleString()} - åé€£æŠ½: ${rec.cards.join(", ")}`;
    }
    const li = document.createElement("li");
    li.textContent = text;
    listEl.appendChild(li);
  }
}

/* é é¢åˆå§‹åŒ– */
window.onload = () => {
  const savedSeat = localStorage.getItem("seat");
  const savedName = localStorage.getItem("name");
  if (savedSeat && savedName) {
    seat = savedSeat;
    name = savedName;
    setupUser();
  } else {
    document.getElementById("setupBox").style.display = "block";
  }
};
</script>

</body>
</html>
