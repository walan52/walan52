<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>多筆定時播放音檔（含網址與YouTube音檔，音量最大）</title>
<style>
  body {
    font-family: Arial;
    text-align: center;
    padding: 30px;
  }
  input, button, select {
    font-size: 18px;
    padding: 8px;
    margin: 5px;
  }
  table {
    margin: 20px auto;
    border-collapse: collapse;
    width: 90%;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 10px;
    font-size: 18px;
  }
  iframe, audio {
    display: none;
  }
</style>
</head>
<body>

<h2>⏰ 多筆定時播放音檔（含內建語音，網址與YouTube支援）</h2>

<!-- 時間輸入 -->
<input type="time" id="timeInput" />

<!-- 選擇音檔類型 -->
<select id="sourceType">
  <option value="file">上傳音檔</option>
  <option value="url">音訊網址</option>
</select>

<!-- 上傳檔案 -->
<input type="file" id="fileInput" accept="audio/*" style="display:inline-block;" />

<!-- 網址輸入 -->
<input type="text" id="urlInput" placeholder="請輸入音訊或YouTube網址" style="display:none; width:300px;" />

<button onclick="addSchedule()">新增音檔或網址</button>

<br /><br />

<!-- 內建語音按鈕 -->
<button onclick="addBuiltInVoice('start')">➕ 新增上課語音</button>
<button onclick="addBuiltInVoice('end')">➕ 新增放學語音</button>

<h3>目前設定</h3>
<table>
  <thead>
    <tr>
      <th>時間</th>
      <th>音檔名稱 / 來源</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody id="scheduleList"></tbody>
</table>

<script>
let schedules = [];

// 內建語音文字
const builtInTexts = {
  start: "上課囉！講話就來領一張搗蛋愛數卷。",
  end: "放學囉！一分鐘後離開教室，不然領一張搗蛋愛數卷。"
};

// 當切換音檔來源，顯示或隱藏欄位
document.getElementById('sourceType').addEventListener('change', function() {
  if(this.value === 'file') {
    document.getElementById('fileInput').style.display = 'inline-block';
    document.getElementById('urlInput').style.display = 'none';
  } else {
    document.getElementById('fileInput').style.display = 'none';
    document.getElementById('urlInput').style.display = 'inline-block';
  }
});

// 建立語音物件（文字轉語音）
function createVoice(text) {
  return {
    play: () => {
      let msg = new SpeechSynthesisUtterance(text);
      msg.lang = "zh-TW";
      msg.rate = 1;
      msg.pitch = 1;
      msg.volume = 1.0;
      speechSynthesis.speak(msg);
    }
  };
}

// 判斷是不是YouTube網址
function isYouTubeUrl(url) {
  return /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\//.test(url);
}

// 由YouTube網址取得影片ID
function getYouTubeID(url) {
  let reg = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|embed|shorts|watch)(?:\?v=|\/))|youtu\.be\/)([^&\?\/]+)/;
  let match = url.match(reg);
  return match ? match[1] : null;
}

// 新增內建語音
function addBuiltInVoice(type) {
  const time = document.getElementById("timeInput").value;
  if (!time) {
    alert("請先設定時間！");
    return;
  }
  if (!builtInTexts[type]) {
    alert("內建語音類型錯誤！");
    return;
  }

  schedules.push({
    time: time,
    file: { name: `內建語音 - ${type === 'start' ? '上課語音' : '放學語音'}` },
    audio: createVoice(builtInTexts[type]),
    played: false
  });

  renderList();
}

// 新增排程項目（上傳音檔或網址）
function addSchedule() {
  const time = document.getElementById("timeInput").value;
  if (!time) {
    alert("請選擇時間！");
    return;
  }

  const sourceType = document.getElementById("sourceType").value;

  if (sourceType === "file") {
    const file = document.getElementById("fileInput").files[0];
    if (!file) {
      alert("請選擇音檔！");
      return;
    }
    const audioObj = new Audio(URL.createObjectURL(file));
    audioObj.volume = 1.0;

    schedules.push({
      time: time,
      file: file,
      audio: audioObj,
      played: false
    });

  } else if (sourceType === "url") {
    const url = document.getElementById("urlInput").value.trim();
    if (!url) {
      alert("請輸入網址！");
      return;
    }

    // YouTube網址處理
    if (isYouTubeUrl(url)) {
      const videoId = getYouTubeID(url);
      if (!videoId) {
        alert("無效的YouTube網址！");
        return;
      }

      // 播放YouTube用iframe API模式（我們這裡用自訂物件播放控制）
      schedules.push({
        time: time,
        file: { name: `YouTube影片: ${url}` },
        audio: {
          play: () => {
            playYouTube(videoId);
          }
        },
        played: false
      });

    } else {
      // 一般音訊網址用Audio播放
      const audioObj = new Audio(url);
      audioObj.volume = 1.0;

      schedules.push({
        time: time,
        file: { name: `網址音訊: ${url}` },
        audio: audioObj,
        played: false
      });
    }
  }

  renderList();
}

// 目前頁面動態建立的YouTube播放器容器
let ytPlayerContainer = null;
let ytPlayerIframe = null;
let ytStopTimeout = null;

// 播放YouTube影片（無控制，只自動播放聲音，帶播放結束30秒後自動移除iframe）
function playYouTube(videoId) {
  if (!ytPlayerContainer) {
    ytPlayerContainer = document.createElement('div');
    ytPlayerContainer.style.position = 'fixed';
    ytPlayerContainer.style.left = '-9999px'; // 不顯示畫面
    document.body.appendChild(ytPlayerContainer);
  } else {
    ytPlayerContainer.innerHTML = "";
  }

  const src = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&disablekb=1&modestbranding=1&rel=0&showinfo=0&mute=0`;
  ytPlayerIframe = document.createElement('iframe');
  ytPlayerIframe.width = 0;
  ytPlayerIframe.height = 0;
  ytPlayerIframe.src = src;
  ytPlayerIframe.allow = "autoplay";
  ytPlayerIframe.allowFullscreen = false;
  ytPlayerContainer.appendChild(ytPlayerIframe);

  // 停止並移除iframe（30秒後）
  if (ytStopTimeout) clearTimeout(ytStopTimeout);
  ytStopTimeout = setTimeout(() => {
    if (ytPlayerContainer) ytPlayerContainer.innerHTML = "";
  }, 30000);
}

// 更新表格列表
function renderList() {
  const tbody = document.getElementById("scheduleList");
  tbody.innerHTML = "";

  schedules.forEach((sch, index) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${sch.time}</td>
      <td>${sch.file.name}</td>
      <td><button onclick="removeSchedule(${index})">刪除</button></td>
    `;

    tbody.appendChild(tr);
  });
}

// 刪除
function removeSchedule(index) {
  schedules.splice(index, 1);
  renderList();
}

// 每秒檢查是否到時間播放
setInterval(() => {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2, "0");
  const mm = String(now.getMinutes()).padStart(2, "0");
  const currentTime = `${hh}:${mm}`;

  schedules.forEach(sch => {
    if (sch.time === currentTime) {
      if (!sch.played) {
        if (typeof sch.audio.play === "function") {
          sch.audio.play();
        }
        sch.played = true;
      }
    } else {
      sch.played = false;
    }
  });
}, 1000);
</script>

</body>
</html>
