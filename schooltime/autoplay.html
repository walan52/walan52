<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>å¤šç­†å®šæ™‚æ’­æ”¾éŸ³æª”ï¼ˆå«ç¶²å€èˆ‡YouTubeéŸ³æª”ï¼ŒéŸ³é‡æœ€å¤§ï¼‰</title>

<style>
  body {
    font-family: Arial;
    text-align: center;
    padding: 30px;
  }
  input, button, select {
    font-size: 18px;
    padding: 8px;
    margin: 5px;
  }
  table {
    margin: 20px auto;
    border-collapse: collapse;
    width: 90%;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 10px;
    font-size: 18px;
  }
</style>
</head>
<body>

<h2>â° å¤šç­†å®šæ™‚æ’­æ”¾éŸ³æª”ï¼ˆå«å…§å»ºèªéŸ³ï¼Œç¶²å€èˆ‡YouTubeæ”¯æ´ï¼‰</h2>

<!-- ğŸ”Š éŸ³æ•ˆå•Ÿç”¨ï¼ˆé—œéµï¼‰ -->
<button id="enableSoundBtn" onclick="enableSound()">ğŸ”Š å•Ÿç”¨éŸ³æ•ˆï¼ˆè«‹å…ˆé»ä¸€æ¬¡ï¼‰</button>
<p id="soundStatus" style="color:red;">å°šæœªå•Ÿç”¨éŸ³æ•ˆ</p>

<hr>

<input type="time" id="timeInput" />

<select id="sourceType">
  <option value="file">ä¸Šå‚³éŸ³æª”</option>
  <option value="url">éŸ³è¨Šç¶²å€</option>
</select>

<input type="file" id="fileInput" accept="audio/*" />
<input type="text" id="urlInput" placeholder="è«‹è¼¸å…¥éŸ³è¨Šæˆ– YouTube ç¶²å€" style="display:none;width:320px;">

<button onclick="addSchedule()">æ–°å¢</button>

<br><br>

<button onclick="addBuiltInVoice('start')">â• ä¸Šèª²èªéŸ³</button>
<button onclick="addBuiltInVoice('end')">â• æ”¾å­¸èªéŸ³</button>
<button onclick="addBuiltInVoice('nap')">â• åˆä¼‘èªéŸ³</button>
<button onclick="addBuiltInVoice('flag')">â• å‡æ——èªéŸ³</button>

<h3>ç›®å‰è¨­å®š</h3>
<table>
<thead>
<tr>
<th>æ™‚é–“</th>
<th>å…§å®¹</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody id="scheduleList"></tbody>
</table>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// ================= éŸ³æ•ˆè§£é–ï¼ˆé—œéµï¼‰ =================
let audioUnlocked = false;
let audioContext;

function enableSound() {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  audioContext.resume().then(() => {
    audioUnlocked = true;
    document.getElementById("soundStatus").innerText = "âœ… éŸ³æ•ˆå·²å•Ÿç”¨";
    document.getElementById("soundStatus").style.color = "green";
  });
}

// ================= Firebase =================
firebase.initializeApp({
  apiKey: "AIzaSyCojnWzneUgiM_OTJYqf9oniIIYpyyuT_0",
  authDomain: "test-d18a6.firebaseapp.com",
  databaseURL: "https://test-d18a6-default-rtdb.firebaseio.com",
  projectId: "test-d18a6",
  storageBucket: "test-d18a6.firebasestorage.app",
  messagingSenderId: "441961430247",
  appId: "1:441961430247:web:643e53ce778132cfa47642"
});

const db = firebase.database().ref("schedules");
let schedules = [];

// ================= å…§å»ºèªéŸ³ =================
const builtInTexts = {
  start: "ä¸Šèª²å›‰ï¼è¬›è©±å°±ä¾†é ˜ä¸€å¼µæ—è›‹æ„›æ•¸å·ã€‚",
  end: "æ”¾å­¸å›‰ï¼ä¸€åˆ†é˜å¾Œé›¢é–‹æ•™å®¤ï¼Œä¸ç„¶é ˜ä¸€å¼µæ—è›‹æ„›æ•¸å·ã€‚",
  nap: "åˆä¼‘æ™‚é–“åˆ°å›‰ï¼è¶´ä¸‹ç¡è¦ºï¼Œè¬›è©±å°±é ˜ä¸€å¼µæ—è›‹æ„›æ•¸å·ã€‚",
  flag: "å‡æ——å›‰ï¼ä¸€åˆ†é˜å…§é›¢é–‹æ•™å®¤ï¼Œè¶•å¿«å»æ’éšŠã€‚"
};

function createVoice(text) {
  return {
    play: () => {
      if (!audioUnlocked) return;
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = "zh-TW";
      msg.volume = 1;
      speechSynthesis.speak(msg);
    }
  };
}

// ================= æ–°å¢ =================
function addBuiltInVoice(type) {
  const time = timeInput.value;
  if (!time) return alert("è«‹å…ˆè¨­å®šæ™‚é–“");
  db.push({
    time,
    type: "built-in",
    textType: type,
    name: "å…§å»ºèªéŸ³"
  });
}

function addSchedule() {
  const time = timeInput.value;
  if (!time) return alert("è«‹é¸æ™‚é–“");

  if (sourceType.value === "file") {
    const file = fileInput.files[0];
    if (!file) return alert("è«‹é¸éŸ³æª”");
    const reader = new FileReader();
    reader.onload = e => {
      db.push({
        time,
        type: "file",
        name: file.name,
        base64Audio: e.target.result
      });
    };
    reader.readAsDataURL(file);
  } else {
    const url = urlInput.value.trim();
    if (!url) return alert("è«‹è¼¸å…¥ç¶²å€");
    db.push({
      time,
      type: url.includes("youtube") ? "youtube" : "url",
      url,
      name: url
    });
  }
}

// ================= é¡¯ç¤º =================
db.on("value", snap => {
  schedules = [];
  snap.forEach(c => {
    const v = c.val();
    v.key = c.key;
    schedules.push(v);
  });
  scheduleList.innerHTML = schedules.map(s => `
    <tr>
      <td>${s.time}</td>
      <td>${s.name}</td>
      <td><button onclick="db.child('${s.key}').remove()">åˆªé™¤</button></td>
    </tr>
  `).join("");
});

// ================= å®šæ™‚æ’­æ”¾ =================
setInterval(() => {
  const now = new Date();
  const t = `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;

  schedules.forEach(s => {
    if (s.time === t && !s.played && audioUnlocked) {
      if (s.type === "built-in") createVoice(builtInTexts[s.textType]).play();
      if (s.type === "file") new Audio(s.base64Audio).play();
      if (s.type === "url") new Audio(s.url).play();
      if (s.type === "youtube") window.open(s.url, "_blank");
      s.played = true;
    }
    if (s.time !== t) s.played = false;
  });
}, 1000);
</script>

</body>
</html>
